<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>日本語教育テスト</title>
  <style>
    /* リセット */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    /* ボディ全体の設定 */
    body {
      font-family: 'Arial', sans-serif;
      background-color: #f4f4f4;
      color: #333;
      line-height: 1.6;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
    }
    /* テスト全体のコンテナ */
    .container {
      width: 90%;
      max-width: 800px;
      background-color: #fff;
      padding: 20px 30px;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
    }
    /* ヘッダー（タイトルなど） */
    .header {
      text-align: center;
      margin-bottom: 20px;
    }
    /* 説明Box（文字サイズ拡大） */
    .explanation-box {
      padding: 20px;
      border: 2px solid #ddd;
      border-radius: 8px;
      background-color: #fafafa;
      margin-bottom: 20px;
      font-size: 1.5em;
      text-align: left;
      white-space: pre-wrap;
    }
    /* 各問題用のコンテナ */
    .question-container {
      margin-bottom: 30px;
    }
    /* 画像表示用のコンテナ */
    .image-container {
      text-align: center;
      margin-bottom: 20px;
    }
    .image-container img {
      width: 100%;
      max-height: 400px;
      object-fit: contain;
      border-radius: 4px;
    }
    /* カスタムラジオボタン（同じ幅・中央寄せ・丸み・選択時色変化） */
    .radio-group {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin: 20px 0;
    }
    .radio-label {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 120px;
      padding: 10px;
      font-size: 1.3em;
      border: 2px solid #007BFF;
      border-radius: 10px;
      cursor: pointer;
      transition: background-color 0.3s, color 0.3s;
    }
    .radio-label input {
      display: none;
    }
    .radio-label input:checked + span {
      background-color: #007BFF;
      color: white;
      border-radius: 8px;
      padding: 5px 10px;
    }
    /* ボタン（Go to, Submit）サイズ・フォント拡大 */
    .submit-btn {
      display: inline-block;
      background-color: #007BFF;
      color: #fff;
      padding: 15px 30px;
      font-size: 1.2em;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    .submit-btn:hover {
      background-color: #0056b3;
    }
    /* フェードアウト用のアニメーション（任意） */
    .fade-out {
      animation: fadeOut 0.5s ease-out forwards;
    }
    @keyframes fadeOut {
      from { opacity: 1; }
      to { opacity: 0; }
    }
  </style>
</head>
<body>
  <div class="container">
    <header class="header">
      <h1>日本語教育テスト</h1>
    </header>
    <!-- 動的に内容を差し替えるエリア -->
    <div id="content"></div>
  </div>
  
  <script>
    /* ----- サウンド再生用関数 ----- */
    function playClickSound() {
      new Audio("https://raw.githubusercontent.com/moguura/my-exp-images/main/Click.mp3").play();
    }
    function playSubmitSound() {
      new Audio("https://raw.githubusercontent.com/moguura/my-exp-images/main/Submission.mp3").play();
    }
    
    /* ----- データ定義 ----- */
    // 説明テキスト
    const explanations = {
      box1: `Test 2 
In this test, first look at the image.
Then, listen to the three Japanese audio clips.
After listening, choose the audio clip that matches the image best.
You can listen to each audio clip only once.

Now, let's do an example together.
Please press the "Go to Next" button.`,
      
      box2: `Let's do Example 1.

Example 1:
Which audio clip correctly matches the image?
First, look at the image.
Make sure the image says "Present".

Next, listen to the audio clips.
After the beep sound, you will hear three audio clips.
Choose the correct answer from these three audio clips.

The correct answer for Example 1 is the first one.

When you are ready, please press the "Go to Example 1" button.`,
      
      box3: `The correct answer for Example 1 is the first one.
Even if you know the answer early, you cannot submit it until you finish listening to all three audio clips.

Now, let's do one more example.

Example 2:
Which audio clip correctly matches the image?

First, look at the image.
Make sure the image says "Past".

Next, listen to the audio clips.
After the beep sound, you will hear three audio clips.
Choose the correct answer from these three audio clips.

The correct answer for Example 2 is the third one.

When you are ready, please press the "Go to Example 2" button.`,
      
      box4: `The correct answer for Example 2 is the third one.
Even if you know the answer early, you cannot submit it until you finish listening to all three audio clips.

Just like in Example 1 and Example 2, every image will have either "Present" or "Yesterday" written on it, so listen carefully.

There are a total of 14 questions in this test.
You can only listen to each audio clip once.

Now, let's begin the test.
When you are ready, please press the "Go to Test" button.`
    };

    // 例題データ
    const example1 = {
      image: "https://raw.githubusercontent.com/moguura/my-exp-images/main/rikai-rei-1.JPG",
      audios: {
        a: "https://raw.githubusercontent.com/moguura/my-exp-images/main/rikai-rei-a.wav",
        b: "https://raw.githubusercontent.com/moguura/my-exp-images/main/rikai-rei-b.wav",
        c: "https://raw.githubusercontent.com/moguura/my-exp-images/main/rikai-rei-c.wav"
      },
      correct: "a",
      order: ["a", "b", "c"]  // 固定順序
    };

    const example2 = {
      image: "https://raw.githubusercontent.com/moguura/my-exp-images/main/rikai-rei-2.JPG",
      audios: {
        a: "https://raw.githubusercontent.com/moguura/my-exp-images/main/rikai-rei-a.wav",
        b: "https://raw.githubusercontent.com/moguura/my-exp-images/main/rikai-rei-b.wav",
        c: "https://raw.githubusercontent.com/moguura/my-exp-images/main/rikai-rei-c.wav"
      },
      correct: "c",
      order: ["a", "b", "c"]  // 固定順序
    };

    // 本テストの問題（14問）
    let testQuestions = [];
    for (let i = 1; i <= 14; i++) {
      testQuestions.push({
        id: i,
        image: `https://raw.githubusercontent.com/moguura/my-images/main/rikai-${i}.JPG`,
        audios: {
          a: `https://raw.githubusercontent.com/moguura/my-exp-images/main/rikai-${i}-a.wav`,
          b: `https://raw.githubusercontent.com/moguura/my-exp-images/main/rikai-${i}-b.wav`,
          c: `https://raw.githubusercontent.com/moguura/my-exp-images/main/rikai-${i}-c.wav`
        },
        correct: "a"  // 正解は常にaudio a
      });
    }

    /* ----- ユーティリティ関数 ----- */
    function shuffle(array) {
      for (let i = array.length - 1; i > 0; i--) {
        let j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
      return array;
    }

    /* 音声シーケンス再生関数\n   ・最初にビープ音（共通URL）を再生し、その後指定された順序でaudioを再生します。\n   ・isTestPhaseがtrueの場合はテスト問題用として扱います（音声順序はランダム）。 */
    function playSequence(audios, order, onComplete, isTestPhase) {
      // ビープ音再生
      let beep = new Audio("https://raw.githubusercontent.com/moguura/my-exp-images/main/beep.mp3");
      beep.play().then(() => {
        beep.onended = function() {
          let index = 0;
          function playNext() {
            if (index < order.length) {
              let key = order[index];
              let audio = new Audio(audios[key]);
              audio.play().then(() => {
                audio.onended = function() {
                  index++;
                  setTimeout(playNext, 2000);
                };
              }).catch(err => {
                console.error("Audio playback error:", err);
                index++;
                setTimeout(playNext, 2000);
              });
            } else {
              onComplete();
            }
          }
          playNext();
        };
      }).catch(err => {
        console.error("Beep playback error:", err);
        onComplete();
      });
    }

    /* ----- UI作成関数 ----- */
    /* 説明Box表示関数 */
    function showExplanation(text, buttonText, callback) {
      const content = document.getElementById("content");
      content.innerHTML = `
        <div class="explanation-box">
          ${text.replace(/\n/g, "<br>")}
          <div style="text-align: center; margin-top: 20px;">
            <button id="nextButton" class="submit-btn">${buttonText}</button>
          </div>
        </div>
      `;
      document.getElementById("nextButton").addEventListener("click", function() {
        playClickSound();
        callback();
      });
    }

    /* 例題表示関数（音声は背景再生） */
    function showExample(exampleData, callbackAfterSubmit) {
      const content = document.getElementById("content");
      content.innerHTML = `
        <div class="question-container">
          <div class="image-container">
            <img src="${exampleData.image}" alt="Example Image">
          </div>
          <!-- 音声は背景再生のため非表示 -->\n
          <div id="audioPlayback" style="display:none;"></div>
          <div class="radio-group" id="radioGroup">
            <label class="radio-label"><input type="radio" name="answer" value="${exampleData.correct === 'a' ? 'correct' : 'incorrect'}"><span>1st</span></label>
            <label class="radio-label"><input type="radio" name="answer" value="${exampleData.correct === 'b' ? 'correct' : 'incorrect'}"><span>2nd</span></label>
            <label class="radio-label"><input type="radio" name="answer" value="${exampleData.correct === 'c' ? 'correct' : 'incorrect'}"><span>3rd</span></label>
          </div>
          <div style="text-align: center; margin-top: 20px;">\n
            <button id="submitButton" class="submit-btn" disabled>Submit</button>\n
          </div>\n
        </div>
      `;
      const submitButton = document.getElementById("submitButton");
      // 例題では音声順序は固定（a, b, c）
      playSequence(exampleData.audios, exampleData.order, function() {
        submitButton.disabled = false;
      }, false);
      submitButton.addEventListener("click", function() {
        if (!document.querySelector('input[name="answer"]:checked')) {\n
          alert("Please select an option.");\n
          return;\n
        }\n
        playSubmitSound();\n
        callbackAfterSubmit();\n
      });
    }

    /* テスト問題表示関数 */
    function showTestQuestion(questionData, callbackAfterSubmit) {
      const content = document.getElementById("content");
      // ランダムな順序を生成し、各選択肢の表示テキストも1st, 2nd, 3rdに変更\n
      let options = shuffle(["a", "b", "c"]);
      content.innerHTML = `
        <div class="question-container">
          <div class="image-container">
            <img src="${questionData.image}" alt="Test Question ${questionData.id}">
          </div>
          <!-- 音声は背景再生 -->\n
          <div id="audioPlayback" style="display:none;"></div>
          <div class="radio-group" id="radioGroup">
            <label class="radio-label"><input type="radio" name="answer" value="${options[0] === 'a' ? 'correct' : 'incorrect'}"><span>1st</span></label>
            <label class="radio-label"><input type="radio" name="answer" value="${options[1] === 'a' ? 'correct' : 'incorrect'}"><span>2nd</span></label>
            <label class="radio-label"><input type="radio" name="answer" value="${options[2] === 'a' ? 'correct' : 'incorrect'}"><span>3rd</span></label>
          </div>
          <div style="text-align: center; margin-top: 20px;">\n
            <button id="submitButton" class="submit-btn" disabled>Submit</button>\n
          </div>\n
        </div>
      `;
      const submitButton = document.getElementById("submitButton");
      // テストでは、ビープ音後にランダム順序で音声を再生
      playSequence(questionData.audios, options, function() {
        submitButton.disabled = false;
      }, true);
      submitButton.addEventListener("click", function() {
        if (!document.querySelector('input[name="answer"]:checked')) {\n
          alert("Please select an option.");\n
          return;\n
        }\n
        playSubmitSound();\n
        // 結果記録（正解はaudio a）\n
        let isCorrect = document.querySelector('input[name="answer"]:checked').value === "correct";\n
        testResults.push({\n
          questionId: questionData.id,\n
          answer: document.querySelector('input[name="answer"]:checked').value,\n
          correct: isCorrect\n
        });\n
        callbackAfterSubmit();\n
      });
    }

    /* ----- テスト進行管理 ----- */
    let testResults = [];
    let currentTestIndex = 0;
    function startTestQuestions() {
      if (currentTestIndex >= testQuestions.length) {
        finishTest();
        return;
      }
      showTestQuestion(testQuestions[currentTestIndex], function() {
        currentTestIndex++;
        startTestQuestions();
      });
    }
    function finishTest() {
      const content = document.getElementById("content");
      content.innerHTML = "<h2>Test complete. Thank you for your cooperation.</h2>";
      // ここで結果の記録処理等を追加可能
    }

    /* ----- フロー開始 ----- */
    function startFlow() {
      // 説明Box1
      showExplanation(explanations.box1, "Go to Next", function() {
        // 説明Box2
        showExplanation(explanations.box2, "Go to Example 1", function() {
          // Example 1
          showExample(example1, function() {
            // 説明Box3
            showExplanation(explanations.box3, "Go to Example 2", function() {
              // Example 2
              showExample(example2, function() {
                // 説明Box4
                showExplanation(explanations.box4, "Go to Test", function() {
                  // 本テスト開始
                  startTestQuestions();
                });
              });
            });
          });
        });
      });
    }

    document.addEventListener("DOMContentLoaded", function() {
      if (!document.getElementById("content")) {
        const container = document.querySelector(".container");
        const div = document.createElement("div");
        div.id = "content";
        container.appendChild(div);
      }
      startFlow();
    });
  </script>
</body>
</html>
