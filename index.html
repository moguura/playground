<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Test 2</title>
  <style>
    /* リセット */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    /* ページ全体の設定 */
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
    }
    /* コンテナ：画面中央配置 */
    .container {
      display: flex;
      flex-direction: column;
      justify-content: center; /* 垂直方向の中央寄せ */
      align-items: center;     /* 水平方向の中央寄せ */
      min-height: 100vh;
      width: 90%;
      max-width: 800px;
      background-color: #fff;
      padding: 20px 30px;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
      margin: 0 auto;
    }
    /* 進捗バー（テスト中のみ表示） */
    .progress-bar {
      display: none; /* 説明画面では非表示 */
      justify-content: center;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    .progress-step {
      width: 30px;
      height: 30px;
      border: 2px solid #007BFF;
      border-radius: 50%;
      margin: 5px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.9em;
      background-color: #f0f0f0;
      color: #333;
      user-select: none;
    }
    .progress-step.completed {
      background-color: #007BFF;
      color: #fff;
    }
    /* 説明Box */
    .explanation-box {
      padding: 20px;
      border: 2px solid #ddd;
      border-radius: 8px;
      background-color: #fafafa;
      margin-bottom: 20px;
      font-size: 1.3em;
      line-height: 1.4;
      text-align: left;
      white-space: normal;
    }
    /* ヘッダー（タイトル） */
    .header {
      font-size: 2em;
      margin-bottom: 20px;
      text-align: center;
    }
    /* 問題用コンテナ */
    .question-container {
      margin-bottom: 30px;
      position: relative;
      min-height: 300px;
    }
    /* 画像表示 */
    .image-container {
      text-align: center;
      margin-bottom: 20px;
    }
    .image-container img {
      width: 100%;
      max-height: 400px;
      object-fit: contain;
      border-radius: 4px;
      margin: 0 auto;
      display: block;
    }
    /* カスタムラジオボタン（ボタン風） */
    .radio-group {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin: 20px 0;
    }
    .radio-label {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 120px;
      padding: 10px 15px;
      font-size: 1.3em;
      border: 2px solid #007BFF;
      border-radius: 10px;
      cursor: pointer;
      transition: background-color 0.3s, color 0.3s, box-shadow 0.3s;
      background-color: #f0f0f0;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .radio-label:hover {
      background-color: #e0ebff;
    }
    .radio-label input {
      display: none;
    }
    .radio-label input:checked + span {
      background-color: #007BFF;
      color: white;
      border-radius: 8px;
      padding: 5px 10px;
    }
    /* ボタン（Submit） */
    .submit-btn {
      display: inline-block;
      background-color: #007BFF;
      color: #fff;
      padding: 15px 30px;
      font-size: 1.2em;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    .submit-btn:hover {
      background-color: #0056b3;
    }
    /* フェードアウト */
    .fade-out {
      animation: fadeOut 0.5s ease-out forwards;
    }
    @keyframes fadeOut {
      from { opacity: 1; }
      to { opacity: 0; }
    }
    /* フェードイン */
    .fade-in {
      animation: fadeIn 0.5s ease-in forwards;
    }
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    /* ログ保存ボタンのスタイル */
    #downloadLogButton {
      display: inline-block;
      background-color: #4CAF50;
      color: #fff;
      padding: 10px 20px;
      font-size: 1.1em;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      margin-top: 20px;
      transition: background-color 0.3s;
    }
    #downloadLogButton:hover {
      background-color: #388E3C;
    }
  </style>
</head>
<body>
  <div id="app" class="container"></div>

  <!-- ログ永続化＆ダウンロード用のスクリプト -->
  <script>
    (function() {
      const logBuffer = [];
      const originalLog = console.log;
      console.log = function(...args) {
        const message = args.join(' ');
        logBuffer.push(message);
        originalLog.apply(console, args);
        localStorage.setItem('consoleLog', logBuffer.join('\n'));
      };
      window.saveLog = function() {
        const logContent = localStorage.getItem('consoleLog') || '';
        const blob = new Blob([logContent], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'console-log.txt';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      };
    })();
  </script>

  <script>
    /* ========== サウンド再生用 ========= */
    function playClickSound() {
      new Audio("https://raw.githubusercontent.com/moguura/my-exp-images/main/Click.mp3").play();
    }
    function playSubmitSound() {
      new Audio("https://raw.githubusercontent.com/moguura/my-exp-images/main/Submission.mp3").play();
    }

    /* ========== 説明文データ ========= */
    const explanations = {
      box1: `In this test, first look at the image.<br>
      Then, listen to the four Japanese audio clips.<br>
      After listening, choose the audio clip that matches the image by selecting one of the options and clicking Submit.<br>
      You can listen to each audio clip only once.<br><br>
      Now, let's do an example together.<br>
      Please press the Submit button after selecting your answer.`,
      box2: `Let's do Example 1.<br><br>
      <strong>Example 1:</strong><br>
      Which audio clip correctly matches the image?<br>
      First, look at the image. Make sure the image says <strong>"Present"</strong>.<br>
      Next, listen to the audio clips. After the beep sound, you will hear four audio clips.<br>
      Choose the correct answer and then click the Submit button.<br>
      The correct answer for Example 1 is <strong>the first one</strong>.<br><br>
      When you are ready, please press Submit after selecting your answer.`,
      box3: `The correct answer for Example 1 is <strong>the first one</strong>.<br>
      Even if you know the answer early, you cannot submit until you finish listening to all four audio clips.<br><br>
      Now, let's do one more example.<br><br>
      <strong>Example 2:</strong><br>
      Which audio clip correctly matches the image?<br>
      First, look at the image. Make sure the image says <strong>"Past"</strong>.<br>
      Next, listen to the audio clips. After the beep sound, you will hear four audio clips.<br>
      Choose the correct answer and then click the Submit button.<br>
      The correct answer for Example 2 is <strong>the third one</strong>.<br><br>
      When you are ready, please press Submit after selecting your answer.`,
      box4: `The correct answer for Example 2 is <strong>the third one</strong>.<br>
      Even if you know the answer early, you cannot submit until you finish listening to all four audio clips.<br><br>
      Just like in Example 1 and Example 2, every image will have either <strong>"Present"</strong> or <strong>"Yesterday"</strong> written on it, 
      so listen carefully.<br><br>
      There are a total of 20 questions in this test.<br>
      You can only listen to each audio clip once.<br><br>
      Now, let's begin the test.<br>
      When you are ready, please click Submit after selecting your answer.`
    };
    const explanationBox5 = {
      text: `This is the end of Test 1. Please inform Instructor Takei.`,
      gif: `https://raw.githubusercontent.com/moguura/my-exp-images/main/cracker.gif`
    };

    /* ========== 例題データ ========= */
    const example1 = {
      image: "https://raw.githubusercontent.com/moguura/my-exp-images/main/rikai-rei-1.JPG",
      audios: {
        a: "https://raw.githubusercontent.com/moguura/my-exp-images/main/rikai-rei-a.wav",
        b: "https://raw.githubusercontent.com/moguura/my-exp-images/main/rikai-rei-b.wav",
        c: "https://raw.githubusercontent.com/moguura/my-exp-images/main/rikai-rei-c.wav",
        d: "https://raw.githubusercontent.com/moguura/my-exp-images/main/rikai-rei-d.wav"
      },
      correct: "a",
      order: ["a", "b", "c", "d"]
    };
    const example2 = {
      image: "https://raw.githubusercontent.com/moguura/my-exp-images/main/rikai-rei-2.JPG",
      audios: {
        a: "https://raw.githubusercontent.com/moguura/my-exp-images/main/rikai-rei-a.wav",
        b: "https://raw.githubusercontent.com/moguura/my-exp-images/main/rikai-rei-b.wav",
        c: "https://raw.githubusercontent.com/moguura/my-exp-images/main/rikai-rei-c.wav",
        d: "https://raw.githubusercontent.com/moguura/my-exp-images/main/rikai-rei-d.wav"
      },
      correct: "c",
      order: ["a", "b", "c", "d"]
    };

    /* ========== テスト問題データ（20問） ========= */
    const questionData = [
      { id: 1, imgUrl: "https://raw.githubusercontent.com/moguura/my-exp-images/main/op-1.JPG", japaneseCue: "おおい → にもつは（　　　）。", group: "present" },
      { id: 2, imgUrl: "https://raw.githubusercontent.com/moguura/my-exp-images/main/op-2.JPG", japaneseCue: "おもい → このほんは（　　　）。", group: "present" },
      { id: 3, imgUrl: "https://raw.githubusercontent.com/moguura/my-exp-images/main/op-3.JPG", japaneseCue: "おもしろい → じゅぎょうは（　　　）。", group: "present" },
      { id: 4, imgUrl: "https://raw.githubusercontent.com/moguura/my-exp-images/main/op-4.JPG", japaneseCue: "からい → この<ruby>パスタ<rt>ぱすた</rt></ruby>は（　　　）。", group: "present" },
      { id: 5, imgUrl: "https://raw.githubusercontent.com/moguura/my-exp-images/main/op-5.JPG", japaneseCue: "あたらしい → いえは（　　　）。", group: "present" },
      { id: 6, imgUrl: "https://raw.githubusercontent.com/moguura/my-exp-images/main/op-6.JPG", japaneseCue: "おいしい → くすりは（　　　）。", group: "present" },
      { id: 7, imgUrl: "https://raw.githubusercontent.com/moguura/my-exp-images/main/op-7.JPG", japaneseCue: "ちかい → がっこうは（　　　）。", group: "present" },
      { id: 8, imgUrl: "https://raw.githubusercontent.com/moguura/my-exp-images/main/op-8.JPG", japaneseCue: "むずかしい → べんきょうは（　　　）。", group: "present" },
      { id: 9, imgUrl: "https://raw.githubusercontent.com/moguura/my-exp-images/main/op-9.JPG", japaneseCue: "あつい → ８がつは（　　　）。", group: "yesterday" },
      { id: 10, imgUrl: "https://raw.githubusercontent.com/moguura/my-exp-images/main/op-10.JPG", japaneseCue: "たかい → りょうりは（　　　）。", group: "yesterday" },
      { id: 11, imgUrl: "https://raw.githubusercontent.com/moguura/my-exp-images/main/op-11.JPG", japaneseCue: "たのしい → <ruby>ゲーム<rt>げーむ</rt></ruby>は（　　　）。", group: "yesterday" },
      { id: 12, imgUrl: "https://raw.githubusercontent.com/moguura/my-exp-images/main/op-12.JPG", japaneseCue: "やすい → このT<ruby>シャツ<rt>しゃつ</rt></ruby>は（　　　）。", group: "yesterday" },
      { id: 13, imgUrl: "https://raw.githubusercontent.com/moguura/my-exp-images/main/op-13.JPG", japaneseCue: "おおきい → <ruby>ケーキ<rt>けーき</rt></ruby>は（　　　）。", group: "yesterday" },
      { id: 14, imgUrl: "https://raw.githubusercontent.com/moguura/my-exp-images/main/op-14.JPG", japaneseCue: "さむい → 2がつは（　　　）。", group: "yesterday" },
      { id: 15, imgUrl: "https://raw.githubusercontent.com/moguura/my-exp-images/main/op-15.JPG", japaneseCue: "すずしい → やまは（　　　）。", group: "yesterday" },
      // 問題16の日本語文を変更
      { id: 16, imgUrl: "https://raw.githubusercontent.com/moguura/my-exp-images/main/op-16.JPG", japaneseCue: "いそがしい → せんせいは（　　　）。", group: "yesterday" },
      { id: 17, imgUrl: "https://raw.githubusercontent.com/moguura/my-exp-images/main/op-17.JPG", japaneseCue: "にがい → <ruby>コーヒー<rt>こーひー</rt></ruby>は（　　　）。", group: "present" },
      { id: 18, imgUrl: "https://raw.githubusercontent.com/moguura/my-exp-images/main/op-18.JPG", japaneseCue: "かるい → この<ruby>ベッド<rt>べっど</rt></ruby>は（　　　）。", group: "present" },
      { id: 19, imgUrl: "https://raw.githubusercontent.com/moguura/my-exp-images/main/op-19.JPG", japaneseCue: "ひろい → <ruby>レストラン<rt>れすとらん</rt></ruby>は（　　　）。", group: "yesterday" },
      { id: 20, imgUrl: "https://raw.githubusercontent.com/moguura/my-exp-images/main/op-20.JPG", japaneseCue: "うるさい → としょかんは（　　　）。", group: "yesterday" }
    ];

    // 遷移画面用の画像定義
    const presentTransition = { imgUrl: "https://raw.githubusercontent.com/moguura/my-exp-images/main/Present.JPG" };
    const yesterdayTransition = { imgUrl: "https://raw.githubusercontent.com/moguura/my-exp-images/main/Yesterday.JPG" };

    // ================================
    // 画面遷移の管理
    // ================================
    /*
      ステージ構成：
      0: 説明Box1
      1: 例1前の遷移画面（Present）
      2: 例1
      3: 説明Box2（例1の後）
      4: 例2前の遷移画面（Yesterday）
      5: 例2
      6: 説明Box3 (GO TO TEST)
      7～46: テスト問題（各問題は2画面：偶数は遷移画面、奇数は実際の問題画面；全20問 → 40画面）
      47: 説明Box4（終了＆ログ保存ボタン付き）
    */
    let stageIndex = 0;
    let shuffledQuestions = [];

    function renderStage(index) {
      if (index === 0) {
        // 説明Box1
        showScreen(explanationBox1);
        document.getElementById("nextBtn1").addEventListener("click", () => {
          playClickSound();
          goNext();
        });
      } else if (index === 1) {
        // 例1前の遷移画面（Present）
        renderTransitionScreen(presentTransition.imgUrl, index + 1);
      } else if (index === 2) {
        // 例1
        renderExample(example1);
      } else if (index === 3) {
        // 説明Box2
        showScreen(explanationBox2);
        document.getElementById("nextBtn2").addEventListener("click", () => {
          playClickSound();
          goNext();
        });
      } else if (index === 4) {
        // 例2前の遷移画面（Yesterday）
        renderTransitionScreen(yesterdayTransition.imgUrl, index + 1);
      } else if (index === 5) {
        // 例2
        renderExample(example2);
      } else if (index === 6) {
        // 説明Box3 (GO TO TEST)
        showScreen(explanationBox3);
        document.getElementById("goTestBtn").addEventListener("click", () => {
          playClickSound();
          startTest();
        });
      } else if (index >= 7 && index < 7 + 2 * 20) {
        // テスト問題部分（各問題は2画面：偶数は遷移画面、奇数は実際の問題画面）
        let qIndex = Math.floor((index - 7) / 2); // 0～19
        if ((index - 7) % 2 === 0) {
          // 遷移画面：問題の group に応じた画像表示
          if (shuffledQuestions[qIndex].group === "present") {
            renderTransitionScreen(presentTransition.imgUrl, index + 1);
          } else {
            renderTransitionScreen(yesterdayTransition.imgUrl, index + 1);
          }
        } else {
          // 実際の問題画面
          const progressHTML = renderProgressBar(qIndex, 20);
          const html = `
            ${progressHTML}
            <div class="question-container">
              <img src="${shuffledQuestions[qIndex].imgUrl}" alt="Test Question ${shuffledQuestions[qIndex].displayId}" class="question-image" />
              <p class="japanese-cue">${shuffledQuestions[qIndex].japaneseCue}</p>
              <div class="mic-container">
                <button class="mic-button" id="micBtn"></button>
                <div class="check-icon" id="checkIcon"></div>
              </div>
              <div id="micWarning" class="mic-warning"></div>
            </div>
          `;
          showScreen(html);
          console.log("現在のテスト問題ID:", shuffledQuestions[qIndex].displayId);
          const micBtn = document.getElementById("micBtn");
          if (micBtn) { micBtn.addEventListener("click", startRecognition); }
          micWarningTimeout = setTimeout(() => {
            const warning = document.getElementById("micWarning");
            if (warning) { warning.textContent = "Press the mic button and speak!"; }
          }, 5000);
        }
      } else if (index === 7 + 2 * 20) {
        // 説明Box4（終了＆ログ保存ボタン付き）
        showScreen(explanationBox4);
        document.getElementById("downloadLogButton").addEventListener("click", () => {
          window.saveLog();
        });
      }
    }

    function renderExample(exampleObj) {
      const html = `
        <div class="question-container">
          <img src="${exampleObj.imgUrl}" alt="example image" class="question-image" />
          <p class="japanese-cue">${exampleObj.japaneseCue}</p>
          <div class="mic-container">
            <button class="mic-button" id="micBtn"></button>
            <div class="check-icon" id="checkIcon"></div>
          </div>
          <div id="micWarning" class="mic-warning"></div>
        </div>
      `;
      showScreen(html);
      const micBtn = document.getElementById("micBtn");
      if(micBtn) { micBtn.addEventListener("click", startRecognition); }
      micWarningTimeout = setTimeout(() => {
        const warning = document.getElementById("micWarning");
        if(warning) { warning.textContent = "Press the mic button and speak!"; }
      }, 5000);
    }

    function renderTransitionScreen(imgUrl, nextStage) {
      const html = `
        <div class="question-container">
          <img src="${imgUrl}" alt="transition image" class="transition-image" />
          <button class="button" id="transitionNextBtn">Next</button>
        </div>
      `;
      showScreen(html);
      document.getElementById("transitionNextBtn").addEventListener("click", () => {
        playClickSound();
        stageIndex = nextStage;
        renderStage(stageIndex);
      });
    }

    function goNext() {
      stageIndex++;
      renderStage(stageIndex);
    }

    // テスト開始時、シャッフル後に displayId（1～20）を各問題に再割り当てする
    function startTest() {
      // シャッフルしたコピーを作成
      shuffledQuestions = shuffle(questionData.map(q => Object.assign({}, q)));
      // 各問題に連番（1～20）の displayId を割り当て
      shuffledQuestions.forEach((q, idx) => {
        q.displayId = idx + 1;
      });
      // 各問題に対してランダムな音声順を割り当てる
      assignAudioOrder(shuffledQuestions);
      stageIndex = 7;
      renderStage(stageIndex);
    }

    // 各問題にランダムな音声順（audioOrder）を設定する
    function assignAudioOrder(questions) {
      questions.forEach(q => {
        q.audioOrder = shuffle(["a", "b", "c", "d"].slice());
      });
    }

    window.addEventListener("DOMContentLoaded", () => {
      renderStage(stageIndex);
    });
  </script>
</body>
</html>
