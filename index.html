<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Test 1</title>
  <style>
    /* 全体のレイアウト */
    html, body {
      margin: 0;
      padding: 0;
      font-family: sans-serif;
      background-color: #fff;
      color: #333;
    }
    /* 中央寄せコンテナ */
    .container, #app {
      max-width: 800px;
      margin: 0 auto;
      text-align: center;
      padding: 20px;
    }
    /* 見出し */
    .header {
      font-size: 2.2em;
      margin-bottom: 20px;
    }
    /* 説明文ボックス */
    .explanation-box {
      background-color: #f9f9f9;
      border: 2px solid #ddd;
      padding: 25px;
      margin-bottom: 40px;
      border-radius: 10px;
      text-align: left;
      line-height: 1.6;
      font-size: 1.3em;
    }
    /* ボタンスタイル */
    .button,
    .go-to-test-button {
      display: inline-block;
      background-color: #007BFF;
      color: #fff;
      padding: 14px 28px;
      font-size: 1.1em;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      text-decoration: none;
      transition: background-color 0.3s, transform 0.2s;
      margin-top: 15px;
    }
    .button:hover,
    .go-to-test-button:hover {
      background-color: #0056b3;
      transform: scale(1.05);
    }
    /* 進捗バー */
    .progress-container {
      display: flex;
      justify-content: center;
      margin-bottom: 20px;
      flex-wrap: nowrap;
    }
    .progress-step {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      border: 2px solid #007BFF;
      color: #007BFF;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 5px;
      font-weight: bold;
      transition: background-color 0.3s, color 0.3s;
    }
    .progress-step.completed,
    .progress-step.active {
      background-color: #007BFF;
      color: #fff;
    }
    /* 問題・例の画面コンテナ */
    .question-container {
      margin-bottom: 40px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      min-height: 50vh;
    }
    /* 中央の画像 */
    .question-image {
      max-width: 70%;
      height: auto;
      display: block;
      margin: 0 auto;
    }
    /* 遷移画面用の画像 */
    .transition-image {
      max-width: 80%;
      height: auto;
      display: block;
      margin: 0 auto;
    }
    /* 日本語キュー */
    .japanese-cue {
      font-size: 1.6em;
      color: #006400;
      margin: 25px 0 30px;
      text-align: center;
      white-space: pre-wrap;
    }
    /* マイクボタン */
    .mic-button {
      width: 80px;
      height: 80px;
      background: url("https://raw.githubusercontent.com/moguura/my-exp-images/main/mic.png") no-repeat center center / contain;
      border: none;
      outline: none;
      cursor: pointer;
      transition: transform 0.2s;
    }
    .mic-button:hover {
      transform: scale(1.1);
    }
    .mic-button:active {
      transform: scale(0.95);
    }
    .mic-button.mic-active {
      animation: micGlow 1s infinite alternate;
    }
    @keyframes micGlow {
      0% { filter: drop-shadow(0 0 10px rgba(255, 0, 0, 0.5)); }
      100% { filter: drop-shadow(0 0 20px rgba(255, 0, 0, 1)); }
    }
    /* マイク・チェックアイコンのコンテナ */
    .mic-container {
      position: relative;
      display: inline-block;
    }
    /* チェックアイコンのスタイル */
    .check-icon {
      position: absolute;
      top: 50%;
      left: calc(100% + 10px);
      transform: translateY(-50%);
      width: 70px;
      height: 70px;
      background: url("https://raw.githubusercontent.com/moguura/my-exp-images/main/check.png") no-repeat center center / contain;
      display: none;
    }
    .check-icon.show {
      display: block;
      animation: pop 0.3s forwards;
    }
    @keyframes pop {
      0% { transform: scale(0.5); opacity: 0; }
      100% { transform: scale(1); opacity: 1; }
    }
    /* 警告メッセージ */
    .mic-warning {
      color: red;
      font-size: 1.2em;
      margin-top: 10px;
    }
    /* テスト終了画面 */
    .final-message {
      text-align: center;
      font-size: 1.4em;
      margin-top: 50px;
    }
    .final-illustration {
      max-width: 150px;
      display: block;
      margin: 30px auto;
    }
    /* ログ保存ボタンのスタイル */
    #downloadLogButton {
      display: inline-block;
      background-color: #4CAF50;
      color: #fff;
      padding: 10px 20px;
      font-size: 1.1em;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      margin-top: 20px;
      transition: background-color 0.3s;
    }
    #downloadLogButton:hover { background-color: #388E3C; }
  </style>
</head>
<body>
  <div id="app" class="container"></div>

  <script>
    // クリックとチェック音
    const clickSound = new Audio("https://raw.githubusercontent.com/moguura/my-exp-images/main/Click.mp3");
    const checkSound = new Audio("https://raw.githubusercontent.com/moguura/my-exp-images/main/Submission.mp3");

    // 音声認識とタイマー用
    let recognition = null;
    let recordTimeout, micWarningTimeout, questionSkipTimeout;
    let currentQuestionId;

    function initSpeechRecognition() {
      const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!SR) { alert("SpeechRecognition API 未対応"); return null; }
      const r = new SR(); r.lang = "ja-JP"; r.interimResults = true; r.continuous = true;
      return r;
    }
    function resetSpeechRecognition() { if (recognition) { recognition.abort(); recognition = null; } }

    function startRecognition() {
      clickSound.play(); resetSpeechRecognition(); clearTimeout(micWarningTimeout); clearTimeout(questionSkipTimeout);
      const btn = document.getElementById("micBtn"); btn.disabled = true; btn.classList.add("mic-active");
      recognition = initSpeechRecognition(); if (!recognition) return;
      recordTimeout = setTimeout(() => { console.log(`NoSpeech(timeout) QuestionID: ${currentQuestionId}`); stopRecognition(); }, 10000);
      recognition.onresult = e => {
        for (let i = e.resultIndex; i < e.results.length; i++) {
          if (e.results[i][0].transcript.includes("です")) {
            console.log(`Detected “です” QuestionID: ${currentQuestionId}`);
            clearTimeout(recordTimeout); recognition.stop(); recognition = null; showCheckIcon(); break;
          }
        }
      };
      recognition.onerror = () => stopRecognition();
      recognition.onend = () => console.log("Recognition ended");
      recognition.start();
    }
    function stopRecognition() {
      clearTimeout(recordTimeout); clearTimeout(questionSkipTimeout);
      if (recognition) recognition.stop(); recognition = null;
      document.getElementById("micBtn").classList.remove("mic-active"); showCheckIcon();
    }
    function showCheckIcon() { document.getElementById("checkIcon").classList.add("show"); checkSound.play(); setTimeout(goNext, 2000); }

    const app = document.getElementById("app");
    function showScreen(html) { app.innerHTML = html; }
    function renderProgressBar(cur, total) {
      let html = '<div class="progress-container">';
      for (let i = 0; i < total; i++) {
        const cls = 'progress-step' + (i < cur ? ' completed' : i === cur ? ' active' : '');
        html += `<span class="${cls}">${i+1}</span>`;
      }
      return html + '</div>';
    }
    function shuffle(a){ return a.sort(() => Math.random() - 0.5); }

    // 説明ビデオのURLを更新
    const videoURLs = [
      'https://raw.githubusercontent.com/moguura/my-exp-images/main/test2-1.mp4',
      'https://raw.githubusercontent.com/moguura/my-exp-images/main/test2-2.mp4',
      'https://raw.githubusercontent.com/moguura/my-exp-images/main/test2-3.mp4',
    ];

    // 例題データ
    const example1 = { imgUrl: "https://raw.githubusercontent.com/moguura/my-exp-images/main/op-e.g.1.JPG", japaneseCue: "いい → てんきは（　　　）。" };
    const example2 = { imgUrl: "https://raw.githubusercontent.com/moguura/my-exp-images/main/op-e.g.2.JPG", japaneseCue: "いい → てんきは（　　　）。" };

    // 問題データ (省略: 1〜20)
    const questionData = [
      { id: 1, imgUrl: "https://raw.githubusercontent.com/moguura/my-exp-images/main/op-1.JPG", japaneseCue: "おおい → にもつは（　　　）。", group: "present" },
      /* 以下略 */
      { id: 20, imgUrl: "https://raw.githubusercontent.com/moguura/my-exp-images/main/op-20.JPG", japaneseCue: "うるさい → としょかんは（　　　）。", group: "yesterday" }
    ];
    const presentTransition = { imgUrl: "https://raw.githubusercontent.com/moguura/my-exp-images/main/Present.JPG" };
    const yesterdayTransition = { imgUrl: "https://raw.githubusercontent.com/moguura/my-exp-images/main/Yesterday.JPG" };

    let stageIndex = 0, shuffledQuestions = [];
    function renderStage(index) {
      // 説明ビデオ1
      if (index === 0) {
        showScreen(`<div class="explanation-box"><video id="video1" src="${videoURLs[0]}" controls width="100%"></video></div>`);
        document.getElementById("video1").addEventListener("ended", () => { clickSound.play(); goNext(); });

      // Present 遷移
      } else if (index === 1) {
        renderTransitionScreen(presentTransition.imgUrl, index+1);

      // 例題1
      } else if (index === 2) {
        renderExample(example1);

      // 説明ビデオ2
      } else if (index === 3) {
        showScreen(`<div class="explanation-box"><video id="video2" src="${videoURLs[1]}" controls width="100%"></video></div>`);
        document.getElementById("video2").addEventListener("ended", () => { clickSound.play(); goNext(); });

      // Yesterday 遷移
      } else if (index === 4) {
        renderTransitionScreen(yesterdayTransition.imgUrl, index+1);

      // 例題2
      } else if (index === 5) {
        renderExample(example2);

      // 説明ビデオ3 (GO TO TEST)
      } else if (index === 6) {
        showScreen(`<div class="explanation-box"><video id="video3" src="${videoURLs[2]}" controls width="100%"></video></div>`);
        document.getElementById("video3").addEventListener("ended", () => { clickSound.play(); startTest(); });

      // テスト問題 (7〜46)
      } else if (index >= 7 && index < 7 + 2 * 20) {
        const qIdx = Math.floor((index - 7) / 2);
        if ((index - 7) % 2 === 0) {
          const grpImg = shuffledQuestions[qIdx].group === 'present' ? presentTransition.imgUrl : yesterdayTransition.imgUrl;
          showScreen(`<div class="question-container"><img src="${grpImg}" class="transition-image"><button class="button" id="nextBtn">Next</button></div>`);
          document.getElementById("nextBtn").onclick = () => { clickSound.play(); goNext(); };
        } else {
          clearTimeout(micWarningTimeout); clearTimeout(questionSkipTimeout);
          const q = shuffledQuestions[qIdx]; currentQuestionId = q.id; console.log(`Start QuestionID: ${q.id}`);
          showScreen(renderProgressBar(qIdx, 20) + 
            `<div class="question-container">
              <img src="${q.imgUrl}" class="question-image">
              <p class="japanese-cue">${q.japaneseCue}</p>
              <div class="mic-container">
                <button id="micBtn" class="mic-button"></button>
                <div id="checkIcon" class="check-icon"></div>
              </div>
              <div id="micWarning" class="mic-warning"></div>
            </div>`);
          document.getElementById("micBtn").onclick = startRecognition;
          micWarningTimeout = setTimeout(() => { document.getElementById("micWarning").textContent = "Press the mic button and speak!"; }, 5000);
          questionSkipTimeout = setTimeout(() => { console.log(`Skipped(no mic) QuestionID: ${currentQuestionId}`); goNext(); }, 20000);
        }
      // 終了画面
      } else if (index === 7 + 2 * 20) {
        showScreen(
          `<div class="explanation-box" style="text-align:center;">
            <p>This is the end of Test 1. Please inform Instructor Takei.</p>
            <img src="https://raw.githubusercontent.com/moguura/my-exp-images/main/cracker.gif" alt="Cracker GIF" class="final-illustration">
            <br>
            <button id="downloadLogButton">DO NOT TOUCH</button>
          </div>`
        );
        document.getElementById("downloadLogButton").addEventListener("click", () => {
          const content = localStorage.getItem('consoleLog') || '';
          const blob = new Blob([content], { type: 'text/plain' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a'); a.href = url; a.download = 'console-log.txt'; document.body.appendChild(a); a.click(); document.body.removeChild(a);
        });
      }
    }

    function renderExample(ex) {
      showScreen(
        `<div class="question-container">
          <img src="${ex.imgUrl}" class="question-image" />
          <p class="japanese-cue">${ex.japaneseCue}</p>
          <div class="mic-container">
            <button id="micBtn" class="mic-button"></button>
            <div id="checkIcon" class="check-icon"></div>
          </div>
          <div id="micWarning" class="mic-warning"></div>
        </div>`
      );
      document.getElementById("micBtn").onclick = startRecognition;
      micWarningTimeout = setTimeout(() => { document.getElementById("micWarning").textContent = "Press the mic button and speak!"; }, 5000);
    }

    function renderTransitionScreen(imgUrl, nextStage) {
      showScreen(
        `<div class="question-container">
          <img src="${imgUrl}" class="transition-image" />
          <button class="button" id="transitionNextBtn">Next</button>
        </div>`
      );
      document.getElementById("transitionNextBtn").onclick = () => { clickSound.play(); stageIndex = nextStage; renderStage(stageIndex); };
    }

    function goNext() { clearTimeout(micWarningTimeout); clearTimeout(questionSkipTimeout); stageIndex++; renderStage(stageIndex); }

    function startTest() { shuffledQuestions = shuffle(questionData); stageIndex = 7; renderStage(stageIndex); }

    window.addEventListener('DOMContentLoaded', () => { renderStage(stageIndex); });
  </script>
</body>
</html>
