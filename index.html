<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Test 2</title>
  <style>
    /* リセット */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    /* ボディ全体の設定 */
    body {
      font-family: 'Arial', sans-serif;
      background-color: #f4f4f4;
      color: #333;
      line-height: 1.6;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
    }
    /* テスト全体のコンテナ */
    .container {
      width: 90%;
      max-width: 800px;
      background-color: #fff;
      padding: 20px 30px;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
    }
    /* ヘッダー（タイトルなど） */
    .header {
      text-align: center;
      margin-bottom: 20px;
    }
    /* 説明Box（文字サイズ拡大） */
    .explanation-box {
      padding: 20px;
      border: 2px solid #ddd;
      border-radius: 8px;
      background-color: #fafafa;
      margin-bottom: 20px;
      font-size: 1.5em;
      text-align: left;
      white-space: pre-wrap; /* 改行をそのまま反映 */
    }
    /* 各問題用のコンテナ */
    .question-container {
      margin-bottom: 30px;
    }
    /* 画像表示用のコンテナ */
    .image-container {
      text-align: center;
      margin-bottom: 20px;
    }
    .image-container img {
      width: 100%;
      max-height: 400px;
      object-fit: contain;
      border-radius: 4px;
    }
    /* カスタムラジオボタン（同じ幅・中央寄せ・丸み・選択時色変化） */
    .radio-group {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin: 20px 0;
    }
    .radio-label {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 120px;
      padding: 10px;
      font-size: 1.3em;
      border: 2px solid #007BFF;
      border-radius: 10px;
      cursor: pointer;
      transition: background-color 0.3s, color 0.3s;
    }
    .radio-label input {
      display: none;
    }
    .radio-label input:checked + span {
      background-color: #007BFF;
      color: white;
      border-radius: 8px;
      padding: 5px 10px;
    }
    /* ボタン（Go to, Submit）のサイズ・フォント拡大 */
    .submit-btn {
      display: inline-block;
      background-color: #007BFF;
      color: #fff;
      padding: 15px 30px;
      font-size: 1.2em;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    .submit-btn:hover {
      background-color: #0056b3;
    }
    /* フェードアウト用のアニメーション（任意） */
    .fade-out {
      animation: fadeOut 0.5s ease-out forwards;
    }
    @keyframes fadeOut {
      from { opacity: 1; }
      to { opacity: 0; }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- ヘッダーを「Test 2」に -->
    <header class="header">
      <h1>Test 2</h1>
    </header>
    <!-- 初期表示: 「Go to Next」ボタンのみ -->
    <div id="content" style="text-align:center;">
      <button id="goToNextBtn" class="submit-btn">Go to Next</button>
    </div>
  </div>

  <script>
    /* ==============================
       1) サウンド再生用関数
       ============================== */
    function playClickSound() {
      new Audio("https://raw.githubusercontent.com/moguura/my-exp-images/main/Click.mp3").play();
    }
    function playSubmitSound() {
      new Audio("https://raw.githubusercontent.com/moguura/my-exp-images/main/Submission.mp3").play();
    }

    /* ==============================
       2) 説明文データ
       ============================== */
    const explanations = {
      box1: `In this test, first look at the image.
Then, listen to the three Japanese audio clips.
After listening, choose the audio clip that matches the image best.
You can listen to each audio clip only once.

Now, let's do an example together.
Please press the \"Go to Next\" button.`,
      
      box2: `Let's do Example 1.

Example 1:
Which audio clip correctly matches the image?
First, look at the image.
Make sure the image says \"Present\".

Next, listen to the audio clips.
After the beep sound, you will hear three audio clips.
Choose the correct answer from these three audio clips.

The correct answer for Example 1 is the first one.

When you are ready, please press the \"Go to Example 1\" button.`,
      
      box3: `The correct answer for Example 1 is the first one.
Even if you know the answer early, you cannot submit it until you finish listening to all three audio clips.

Now, let's do one more example.

Example 2:
Which audio clip correctly matches the image?

First, look at the image.
Make sure the image says \"Past\".

Next, listen to the audio clips.
After the beep sound, you will hear three audio clips.
Choose the correct answer from these three audio clips.

The correct answer for Example 2 is the third one.

When you are ready, please press the \"Go to Example 2\" button.`,
      
      box4: `The correct answer for Example 2 is the third one.
Even if you know the answer early, you cannot submit it until you finish listening to all three audio clips.

Just like in Example 1 and Example 2, every image will have either \"Present\" or \"Yesterday\" written on it, so listen carefully.

There are a total of 14 questions in this test.
You can only listen to each audio clip once.

Now, let's begin the test.
When you are ready, please press the \"Go to Test\" button.`
    };

    // テスト終了後に表示するBox5
    const explanationBox5 = {
      text: `This is the end of Test 2.
Please click the X at the top to close this tab.`,
      gif: `https://raw.githubusercontent.com/moguura/my-exp-images/main/cracker.gif`
    };

    /* ==============================
       3) 例題データ
       ============================== */
    const example1 = {
      image: "https://raw.githubusercontent.com/moguura/my-exp-images/main/rikai-rei-1.JPG",
      audios: {
        a: "https://raw.githubusercontent.com/moguura/my-exp-images/main/rikai-rei-a.wav",
        b: "https://raw.githubusercontent.com/moguura/my-exp-images/main/rikai-rei-b.wav",
        c: "https://raw.githubusercontent.com/moguura/my-exp-images/main/rikai-rei-c.wav"
      },
      correct: "a",
      order: ["a", "b", "c"]
    };
    const example2 = {
      image: "https://raw.githubusercontent.com/moguura/my-exp-images/main/rikai-rei-2.JPG",
      audios: {
        a: "https://raw.githubusercontent.com/moguura/my-exp-images/main/rikai-rei-a.wav",
        b: "https://raw.githubusercontent.com/moguura/my-exp-images/main/rikai-rei-b.wav",
        c: "https://raw.githubusercontent.com/moguura/my-exp-images/main/rikai-rei-c.wav"
      },
      correct: "c",
      order: ["a", "b", "c"]
    };

    /* ==============================
       4) テスト問題データ（14問）
       ============================== */
    let testQuestions = [];
    for (let i = 1; i <= 14; i++) {
      testQuestions.push({
        id: i,
        image: `https://raw.githubusercontent.com/moguura/my-exp-images/main/rikai-${i}.JPG`,
        audios: {
          a: `https://raw.githubusercontent.com/moguura/my-exp-images/main/rikai-${i}-a.wav`,
          b: `https://raw.githubusercontent.com/moguura/my-exp-images/main/rikai-${i}-b.wav`,
          c: `https://raw.githubusercontent.com/moguura/my-exp-images/main/rikai-${i}-c.wav`
        },
        correct: "a"
      });
    }

    /* ==============================
       5) ユーティリティ関数
       ============================== */
    // シャッフル
    function shuffle(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
      return array;
    }

    // 音声シーケンス再生
    function playSequence(audios, order, onComplete, isTestPhase) {
      // ビープ音
      const beep = new Audio("https://raw.githubusercontent.com/moguura/my-exp-images/main/beep.mp3");
      beep.play().then(() => {
        beep.onended = () => {
          let index = 0;
          function playNext() {
            if (index < order.length) {
              const key = order[index];
              const audio = new Audio(audios[key]);
              audio.play().then(() => {
                audio.onended = () => {
                  index++;
                  setTimeout(playNext, 2000);
                };
              }).catch(err => {
                console.error("Audio playback error:", err);
                index++;
                setTimeout(playNext, 2000);
              });
            } else {
              onComplete();
            }
          }
          playNext();
        };
      }).catch(err => {
        console.error("Beep playback error:", err);
        onComplete();
      });
    }

    /* ==============================
       6) UI表示用の関数
       ============================== */
    // 説明Box表示
    function showExplanation(text, buttonText, callback) {
      const content = document.getElementById("content");
      content.innerHTML = `
        <div class="explanation-box">
          ${text.replace(/\n/g, "<br>")}
          <div style="text-align: center; margin-top: 20px;">
            <button id="nextButton" class="submit-btn">${buttonText}</button>
          </div>
        </div>
      `;
      const nextBtn = document.getElementById("nextButton");
      nextBtn.addEventListener("click", () => {
        playClickSound();
        callback();
      });
    }

    // 例題表示
    function showExample(exampleData, callbackAfterSubmit) {
      const content = document.getElementById("content");
      content.innerHTML = `
        <div class="question-container">
          <div class="image-container">
            <img src="${exampleData.image}" alt="Example Image">
          </div>
          <div id="audioPlayback" style="display:none;"></div>
          <div class="radio-group" id="radioGroup">
            <label class="radio-label">
              <input type="radio" name="answer" value="${exampleData.correct === 'a' ? 'correct' : 'incorrect'}">
              <span>1st</span>
            </label>
            <label class="radio-label">
              <input type="radio" name="answer" value="${exampleData.correct === 'b' ? 'correct' : 'incorrect'}">
              <span>2nd</span>
            </label>
            <label class="radio-label">
              <input type="radio" name="answer" value="${exampleData.correct === 'c' ? 'correct' : 'incorrect'}">
              <span>3rd</span>
            </label>
          </div>
          <div style="text-align: center; margin-top: 20px;">
            <button id="submitButton" class="submit-btn" disabled>Submit</button>
          </div>
        </div>
      `;
      const submitButton = document.getElementById("submitButton");
      // 固定順序で再生
      playSequence(exampleData.audios, exampleData.order, () => {
        submitButton.disabled = false;
      }, false);

      submitButton.addEventListener("click", () => {
        const selected = document.querySelector('input[name="answer"]:checked');
        if (!selected) {
          alert("Please select an option.");
          return;
        }
        playSubmitSound();
        callbackAfterSubmit();
      });
    }

    // テスト問題表示
    let testResults = [];
    function showTestQuestion(questionData, callbackAfterSubmit) {
      const content = document.getElementById("content");
      // ランダム順序
      const options = shuffle(["a", "b", "c"]);
      content.innerHTML = `
        <div class="question-container">
          <div class="image-container">
            <img src="${questionData.image}" alt="Test Question ${questionData.id}">
          </div>
          <div id="audioPlayback" style="display:none;"></div>
          <div class="radio-group" id="radioGroup">
            <label class="radio-label">
              <input type="radio" name="answer" value="${options[0] === 'a' ? 'correct' : 'incorrect'}">
              <span>1st</span>
            </label>
            <label class="radio-label">
              <input type="radio" name="answer" value="${options[1] === 'a' ? 'correct' : 'incorrect'}">
              <span>2nd</span>
            </label>
            <label class="radio-label">
              <input type="radio" name="answer" value="${options[2] === 'a' ? 'correct' : 'incorrect'}">
              <span>3rd</span>
            </label>
          </div>
          <div style="text-align: center; margin-top: 20px;">
            <button id="submitButton" class="submit-btn" disabled>Submit</button>
          </div>
        </div>
      `;
      const submitButton = document.getElementById("submitButton");
      // ランダム順序で再生
      playSequence(questionData.audios, options, () => {
        submitButton.disabled = false;
      }, true);

      submitButton.addEventListener("click", () => {
        const selected = document.querySelector('input[name="answer"]:checked');
        if (!selected) {
          alert("Please select an option.");
          return;
        }
        playSubmitSound();
        const isCorrect = (selected.value === "correct");
        testResults.push({
          questionId: questionData.id,
          answer: selected.value,
          correct: isCorrect
        });
        callbackAfterSubmit();
      });
    }

    /* ==============================
       7) テスト終了時の処理
       ============================== */
    function finishTest() {
      // ここでBox5を表示する
      const content = document.getElementById("content");
      content.innerHTML = `
        <div class="explanation-box" style="text-align:center;">
          <p style="margin-bottom: 20px; font-size: 1.4em;">
            ${explanationBox5.text.replace(/\n/g, "<br>")}
          </p>
          <img src="${explanationBox5.gif}" alt="Cracker GIF" style="max-width: 300px;">
        </div>
      `;
      // 必要なら testResults をサーバに送る処理などをここで追加
    }

    /* ==============================
       8) テスト進行管理
       ============================== */
    let currentTestIndex = 0;
    function startTestQuestions() {
      currentTestIndex = 0; // 念のため初期化
      // テスト問題をランダム化する場合はここで
      // testQuestions = shuffle(testQuestions);

      function nextQuestion() {
        if (currentTestIndex >= testQuestions.length) {
          finishTest();
          return;
        }
        showTestQuestion(testQuestions[currentTestIndex], () => {
          currentTestIndex++;
          nextQuestion();
        });
      }
      nextQuestion();
    }

    /* ==============================
       9) 全体のフロー開始
       ============================== */
    function startFlow() {
      // Box1
      showExplanation(explanations.box1, "Go to Next", function() {
        // Box2
        showExplanation(explanations.box2, "Go to Example 1", function() {
          // Example1
          showExample(example1, function() {
            // Box3
            showExplanation(explanations.box3, "Go to Example 2", function() {
              // Example2
              showExample(example2, function() {
                // Box4
                showExplanation(explanations.box4, "Go to Test", function() {
                  // テスト開始
                  startTestQuestions();
                });
              });
            });
          });
        });
      });
    }

    // ページ読み込み時
    document.addEventListener("DOMContentLoaded", () => {
      const goToNextBtn = document.getElementById("goToNextBtn");
      goToNextBtn.addEventListener("click", () => {
        playClickSound();
        startFlow();
      });
    });
  </script>
</body>
</html>
