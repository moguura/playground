<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Test 1</title>
  <style>
    /* 全体のレイアウト */
    html, body {
      margin: 0;
      padding: 0;
      font-family: sans-serif;
      background-color: #fff;
      color: #333;
    }
    /* 中央寄せコンテナ */
    .container, #app {
      max-width: 700px;
      margin: 0 auto;
      text-align: center;
      padding: 20px;
    }
    /* 見出し（例：Test 1 など） */
    .header {
      font-size: 2em;
      margin-bottom: 20px;
    }
    /* 説明文を囲むボックス */
    .explanation-box {
      background-color: #f9f9f9;
      border: 2px solid #ddd;
      padding: 20px;
      margin-bottom: 30px;
      border-radius: 8px;
      text-align: left;
      line-height: 1.5;
    }
    /* ボタン共通スタイル */
    .button,
    .go-to-test-button {
      display: inline-block;
      background-color: #007BFF;
      color: #fff;
      padding: 14px 28px;
      font-size: 1em;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      text-decoration: none;
      transition: background-color 0.3s;
    }
    .button:hover,
    .go-to-test-button:hover {
      background-color: #0056b3;
    }
    /* 問題文全体のコンテナ */
    .question-container {
      margin-bottom: 40px;
    }
    /* メイン文章 */
    .test-sentence {
      font-size: 1.3em;
      margin: 20px 0 10px;
      text-align: center;
      white-space: pre-wrap;
    }
    /* 日本語キュー部分 */
    .japanese-cue {
      font-size: 1.3em;
      color: #006400;
      margin-bottom: 20px;
      text-align: center;
    }
    /* マイクボタン */
    .mic-button {
      width: 70px;
      height: 70px;
      background: url("https://raw.githubusercontent.com/moguura/my-exp-images/main/mic.png") no-repeat center center / contain;
      border: none;
      outline: none;
      cursor: pointer;
      margin: 20px auto;
      transition: transform 0.2s;
      display: inline-block;
    }
    .mic-button:hover {
      transform: scale(1.1);
    }
    .mic-button:active {
      transform: scale(0.95);
    }
    .mic-button.mic-active {
      animation: micGlow 1s infinite alternate;
    }
    @keyframes micGlow {
      0% {
        box-shadow: 0 0 10px rgba(255, 0, 0, 0.5);
      }
      100% {
        box-shadow: 0 0 20px rgba(255, 0, 0, 1);
      }
    }
    /* 音量レベルメーター */
    .voice-level-meter {
      width: 200px;
      height: 10px;
      background-color: #ddd;
      border-radius: 5px;
      margin: 10px auto;
      overflow: hidden;
      position: relative;
    }
    .voice-level-bar {
      height: 100%;
      width: 0%;
      background-color: #4caf50;
      transition: width 0.1s;
    }
    /* チェックアイコン */
    .check-icon {
      width: 60px;
      height: 60px;
      background: url("https://raw.githubusercontent.com/moguura/my-exp-images/main/check.png") no-repeat center center / contain;
      display: none;
      margin: 20px auto;
    }
    .check-icon.show {
      display: block;
      animation: pop 0.3s forwards;
    }
    @keyframes pop {
      0% {
        transform: scale(0.5);
        opacity: 0;
      }
      100% {
        transform: scale(1);
        opacity: 1;
      }
    }
    /* テスト終了画面 */
    .final-message {
      text-align: center;
      font-size: 1.2em;
      margin-top: 40px;
    }
    .final-illustration {
      max-width: 300px;
      display: block;
      margin: 20px auto;
    }
  </style>
</head>
<body>
  <div id="app" class="container">
    <!-- 初期表示コンテンツ（ここは JavaScript で切り替えます） -->
    <div class="explanation-box">
      <p>説明文1・・・</p>
    </div>
    
    <div class="question-container">
      <p class="test-sentence">The weather is not good.</p>
      <p class="japanese-cue">いい → てんきは（　　）</p>
      <button class="mic-button" id="micBtn"></button>
      <div class="voice-level-meter" id="meter">
        <div class="voice-level-bar" id="levelBar"></div>
      </div>
      <div class="check-icon" id="checkIcon"></div>
    </div>
    
    <button class="go-to-test-button" id="goToTestBtn">GO TO TEST</button>
    
    <div class="final-message">
      <p>This is the end of Test 1. Please click the X at the top to close this tab.</p>
      <img src="https://raw.githubusercontent.com/moguura/my-exp-images/main/cracker.gif" alt="Cracker GIF" class="final-illustration">
    </div>
  </div>
  <script>
    /***************************************
     * 1. テスト用テキスト（説明文・問題文）
     ***************************************/
    const explanation1 = `
      <h2 class="header">Test 1</h2>
      <div class="explanation-box">
        <p>This is a speaking test.<br>
        Press the microphone button and speak.<br>
        Now, let's try an example. Press the microphone button and say "よくないです".</p>
      </div>
      <button class="button" id="goExampleBtn">Next</button>
    `;
    
    const exampleQuestion = {
      english: "The weather is not good.",
      japaneseCue: "いい → てんきは（　　　）"
    };
    
    const explanation2 = `
      <div class="explanation-box">
        <p>The weather is not good. Therefore, "いい" becomes "よくないです."<br>
        Similarly, change the form of い-adjectives and speak the word that fits in the (　　 ).<br><br>
        When you're ready, press the GO TO TEST button to begin.</p>
      </div>
      <button class="go-to-test-button" id="goTestBtn">GO TO TEST</button>
    `;
    
    const explanation3 = `
      <div class="explanation-box">
        <p>This is the end of Test 1. Please click the X at the top to close this tab.</p>
      </div>
      <img src="https://raw.githubusercontent.com/moguura/my-exp-images/main/cracker.gif"
           alt="Cracker GIF" class="final-illustration">
    `;
    
    const questions = [
      { english: "The class is interesting.", japaneseCue: "おもしろい → じゅぎょうは（　　　）" },
      { english: "This pasta is spicy.", japaneseCue: "からい → このパスタは（　　　）" },
      // ...（他の問題も同様に追加）
    ];
    
    /***************************************
     * 2. グローバル変数・ユーティリティ
     ***************************************/
    const app = document.getElementById("app");
    let audioContext = null, analyser = null, microphoneStream = null, animationId = null;
    let isRecording = false, lastSpokeTime = null;
    const SILENCE_THRESHOLD = 0.02, SILENCE_DURATION = 2000;
    const checkSound = new Audio("https://raw.githubusercontent.com/moguura/my-exp-images/main/Submission.mp3");
    
    function shuffle(array) {
      const arr = [...array];
      for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      return arr;
    }
    
    /***************************************
     * 3. 音声関連の初期化・音量メーター更新
     ***************************************/
    async function initAudio() {
      if (!audioContext) {
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
      }
      try {
        microphoneStream = await navigator.mediaDevices.getUserMedia({ audio: true });
        const source = audioContext.createMediaStreamSource(microphoneStream);
        analyser = audioContext.createAnalyser();
        analyser.fftSize = 512;
        source.connect(analyser);
      } catch (err) {
        console.warn("マイクが許可されなかったため、ランダム音量でメーターを動かします。", err);
        analyser = null;
      }
    }
    
    function updateVolumeMeter() {
      if (!isRecording) {
        setVoiceLevelBar(0);
        animationId = requestAnimationFrame(updateVolumeMeter);
        return;
      }
      let volume = 0;
      if (analyser) {
        const dataArray = new Uint8Array(analyser.frequencyBinCount);
        analyser.getByteFrequencyData(dataArray);
        let sum = 0;
        for (let i = 0; i < dataArray.length; i++) {
          sum += dataArray[i];
        }
        volume = (sum / dataArray.length) / 128;
      } else {
        volume = Math.random() * 0.4;
      }
      setVoiceLevelBar(volume);
      if (volume > SILENCE_THRESHOLD) {
        lastSpokeTime = performance.now();
      }
      if (lastSpokeTime !== null && performance.now() - lastSpokeTime > SILENCE_DURATION) {
        showCheckIconAndNext();
      }
      animationId = requestAnimationFrame(updateVolumeMeter);
    }
    
    function setVoiceLevelBar(volume) {
      const levelBar = document.getElementById("levelBar");
      if (levelBar) {
        const percentage = Math.min(volume * 100, 100);
        levelBar.style.width = percentage + "%";
      }
    }
    
    function startRecording() {
      isRecording = true;
      lastSpokeTime = performance.now();
      const micBtn = document.getElementById("micBtn");
      if (micBtn) {
        micBtn.classList.add("mic-active");
      }
    }
    
    function stopRecording() {
      isRecording = false;
      const micBtn = document.getElementById("micBtn");
      if (micBtn) {
        micBtn.classList.remove("mic-active");
      }
    }
    
    function showCheckIconAndNext() {
      stopRecording();
      const checkIcon = document.getElementById("checkIcon");
      if (checkIcon) {
        checkIcon.classList.add("show");
      }
      checkSound.play();
      setTimeout(() => {
        goToNextQuestion();
      }, 1000);
    }
    
    /***************************************
     * 4. 画面切り替え（HTML生成）用関数
     ***************************************/
    function showScreen(htmlString) {
      app.innerHTML = htmlString;
    }
    
    function renderExplanation1() {
      showScreen(explanation1);
      const btn = document.getElementById("goExampleBtn");
      if (btn) {
        btn.addEventListener("click", () => {
          renderExample();
        });
      }
    }
    
    function renderExample() {
      showScreen(`
        <h2 class="header">Example</h2>
        <div class="question-container">
          <p class="test-sentence">${exampleQuestion.english}</p>
          <p class="japanese-cue">${exampleQuestion.japaneseCue}</p>
          <button class="mic-button" id="micBtn"></button>
          <div class="voice-level-meter" id="meter">
            <div class="voice-level-bar" id="levelBar"></div>
          </div>
          <div class="check-icon" id="checkIcon"></div>
        </div>
      `);
      const micBtn = document.getElementById("micBtn");
      if (micBtn) {
        micBtn.addEventListener("click", () => {
          startRecording();
        });
      }
    }
    
    function renderExplanation2() {
      showScreen(explanation2);
      const goTestButton = document.getElementById("goTestBtn");
      if (goTestButton) {
        goTestButton.addEventListener("click", () => {
          startTest();
        });
      }
    }
    
    function renderQuestion(q) {
      showScreen(`
        <div class="question-container">
          <p class="test-sentence">${q.english}</p>
          <p class="japanese-cue">${q.japaneseCue}</p>
          <button class="mic-button" id="micBtn"></button>
          <div class="voice-level-meter" id="meter">
            <div class="voice-level-bar" id="levelBar"></div>
          </div>
          <div class="check-icon" id="checkIcon"></div>
        </div>
      `);
      const micBtn = document.getElementById("micBtn");
      if (micBtn) {
        micBtn.addEventListener("click", () => {
          startRecording();
        });
      }
    }
    
    function renderFinal() {
      showScreen(explanation3);
    }
    
    /***************************************
     * 5. テスト進行管理
     ***************************************/
    let shuffledQuestions = [];
    let currentQuestionIndex = 0;
    
    function startTest() {
      shuffledQuestions = shuffle(questions);
      currentQuestionIndex = 0;
      renderQuestion(shuffledQuestions[currentQuestionIndex]);
    }
    
    function goToNextQuestion() {
      currentQuestionIndex++;
      if (currentQuestionIndex < shuffledQuestions.length) {
        renderQuestion(shuffledQuestions[currentQuestionIndex]);
      } else {
        renderFinal();
      }
    }
    
    /***************************************
     * 6. ページ読み込み時の初期化
     ***************************************/
    window.addEventListener("DOMContentLoaded", async () => {
      await initAudio();
      function meterLoop() {
        animationId = requestAnimationFrame(updateVolumeMeter);
      }
      meterLoop();
      renderExplanation1();
      const originalGoNext = goToNextQuestion;
      goToNextQuestion = () => {
        if (currentQuestionIndex === 0 && shuffledQuestions.length === 0) {
          renderExplanation2();
        } else {
          originalGoNext();
        }
      };
    });
  </script>
</body>
</html>
