<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Test 1</title>
  <style>
    /* 全体のレイアウト */
    html, body {
      margin: 0;
      padding: 0;
      font-family: sans-serif;
      background-color: #fff;
      color: #333;
    }
    /* 中央寄せコンテナ */
    .container, #app {
      max-width: 800px;
      margin: 0 auto;
      text-align: center;
      padding: 20px;
    }
    /* 見出し */
    .header {
      font-size: 2.5em;
      margin-bottom: 30px;
    }
    /* 説明文ボックス */
    .explanation-box {
      background-color: #f9f9f9;
      border: 2px solid #ddd;
      padding: 25px;
      margin-bottom: 40px;
      border-radius: 10px;
      text-align: left;
      line-height: 1.6;
      font-size: 1.1em;
    }
    /* ボタンスタイル */
    .button,
    .go-to-test-button {
      display: inline-block;
      background-color: #007BFF;
      color: #fff;
      padding: 16px 32px;
      font-size: 1.2em;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      text-decoration: none;
      transition: background-color 0.3s, transform 0.2s;
    }
    .button:hover,
    .go-to-test-button:hover {
      background-color: #0056b3;
      transform: scale(1.05);
    }
    /* 問題文全体のコンテナ */
    .question-container {
      margin-bottom: 50px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      min-height: 60vh;
    }
    /* メイン文章 */
    .test-sentence {
      font-size: 1.8em;
      margin: 30px 0 20px;
      text-align: center;
      white-space: pre-wrap;
    }
    /* 日本語キュー */
    .japanese-cue {
      font-size: 1.8em;
      color: #006400;
      margin-bottom: 30px;
      text-align: center;
    }
    /* マイクボタン */
    .mic-button {
      width: 80px;
      height: 80px;
      background: url("https://raw.githubusercontent.com/moguura/my-exp-images/main/mic.png") no-repeat center center / contain;
      border: none;
      outline: none;
      cursor: pointer;
      margin: 30px auto;
      transition: transform 0.2s;
      display: inline-block;
    }
    .mic-button:hover {
      transform: scale(1.1);
    }
    .mic-button:active {
      transform: scale(0.95);
    }
    .mic-button.mic-active {
      animation: micGlow 1s infinite alternate;
    }
    @keyframes micGlow {
      0% {
        filter: drop-shadow(0 0 10px rgba(255, 0, 0, 0.5));
      }
      100% {
        filter: drop-shadow(0 0 20px rgba(255, 0, 0, 1));
      }
    }
    /* チェックアイコン */
    .check-icon {
      width: 70px;
      height: 70px;
      background: url("https://raw.githubusercontent.com/moguura/my-exp-images/main/check.png") no-repeat center center / contain;
      display: none;
      margin: 30px auto;
    }
    .check-icon.show {
      display: block;
      animation: pop 0.3s forwards;
    }
    @keyframes pop {
      0% {
        transform: scale(0.5);
        opacity: 0;
      }
      100% {
        transform: scale(1);
        opacity: 1;
      }
    }
    /* テスト終了画面 */
    .final-message {
      text-align: center;
      font-size: 1.4em;
      margin-top: 50px;
    }
    .final-illustration {
      max-width: 350px;
      display: block;
      margin: 30px auto;
    }
  </style>
</head>
<body>
  <div id="app" class="container">
    <!-- コンテンツはJavaScriptで動的に生成されます -->
  </div>
  <script>
    // JavaScriptコード
    const app = document.getElementById("app");
    let audioContext = null, analyser = null, microphoneStream = null, animationId = null;
    let isRecording = false, lastSpokeTime = null, recordingStartTime = null;
    const SILENCE_THRESHOLD = 0.02;
    const SILENCE_DURATION = 2000; // 2秒
    const MIN_RECORDING_TIME = 2000; // 録音開始後、最低2秒は待つ
    const checkSound = new Audio("https://raw.githubusercontent.com/moguura/my-exp-images/main/Submission.mp3");

    const explanation1 = `
      <h2 class="header">Test 1</h2>
      <div class="explanation-box">
        <p>This is a speaking test.<br>
        Press the microphone button and speak.<br>
        Now, let's try an example. Press the microphone button and say "よくないです".</p>
      </div>
      <button class="button" id="goExampleBtn">Next</button>
    `;

    const exampleQuestion = {
      english: "The weather is not good.",
      japaneseCue: "いい → てんきは（　　　）"
    };

    const explanation2 = `
      <div class="explanation-box">
        <p>The weather is not good. Therefore, "いい" becomes "よくないです."<br>
        Similarly, change the form of い-adjectives and speak the word that fits in the (　　 ).<br><br>
        When you're ready, press the GO TO TEST button to begin.</p>
      </div>
      <button class="go-to-test-button" id="goTestBtn">GO TO TEST</button>
    `;

    const explanation3 = `
      <div class="explanation-box">
        <p>This is the end of Test 1. Please click the X at the top to close this tab.</p>
      </div>
      <img src="https://raw.githubusercontent.com/moguura/my-exp-images/main/cracker.gif"
           alt="Cracker GIF" class="final-illustration">
    `;

    // 16問の問題リスト（ランダム表示）
    const questions = [
      { english: "The class is interesting.", japaneseCue: "おもしろい → じゅぎょうは（　　　）" },
      { english: "This pasta is spicy.", japaneseCue: "からい → このパスタは（　　　）" },
      { english: "The medicine is not tasty.", japaneseCue: "おいしい → くすりは（　　　）" },
      { english: "Studying is not difficult.", japaneseCue: "むずかしい → べんきょうは（　　　）" },
      { english: "The food was expensive.", japaneseCue: "たかい → りょうりは（　　　）" },
      { english: "This T-shirt was cheap.", japaneseCue: "やすい → このTシャツは（　　　）" },
      { english: "The cake was not big.", japaneseCue: "おおきい → ケーキは（　　　）" },
      { english: "February was not cold.", japaneseCue: "さむい → 2がつは（　　　）" },
      { english: "The house is not new.", japaneseCue: "あたらしい → いえは（　　　）" },
      { english: "Last week was hot.", japaneseCue: "あつい → せんしゅうは（　　　）" },
      { english: "The game is fun.", japaneseCue: "たのしい → ゲームは（　　　）" },
      { english: "There was a lot of luggage.", japaneseCue: "おおい → にもつは（　　　）" },
      { english: "This book is heavy.", japaneseCue: "おもい → このほんは（　　　）" },
      { english: "The mountain was not cool.", japaneseCue: "すずしい → やまは（　　　）" },
      { english: "The school is not close.", japaneseCue: "ちかい → がっこうは（　　　）" },
      { english: "The hot spring was not cold.", japaneseCue: "つめたい → おんせんは（　　　）" }
    ];

    // 配列をシャッフルする
    function shuffle(array) {
      const arr = [...array];
      for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      return arr;
    }

    async function initAudio() {
      if (!audioContext) {
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
      }
      try {
        microphoneStream = await navigator.mediaDevices.getUserMedia({ audio: true });
        const source = audioContext.createMediaStreamSource(microphoneStream);
        analyser = audioContext.createAnalyser();
        analyser.fftSize = 512;
        source.connect(analyser);
      } catch (err) {
        console.warn("マイクが許可されなかったため、シミュレーションします。", err);
        analyser = null;
      }
    }

    // updateVolumeMeterでは画面上の音量表示は行わず、音量を使って発話の有無を判定するのみ
    function updateVolumeMeter() {
      if (!isRecording) {
        animationId = requestAnimationFrame(updateVolumeMeter);
        return;
      }
      let volume = 0;
      if (analyser) {
        const dataArray = new Uint8Array(analyser.frequencyBinCount);
        analyser.getByteFrequencyData(dataArray);
        let sum = 0;
        for (let i = 0; i < dataArray.length; i++) {
          sum += dataArray[i];
        }
        volume = sum / dataArray.length / 255;
      } else {
        volume = Math.random() * 0.7 + 0.3;
      }
      // 発話があれば lastSpokeTime を更新
      if (volume > SILENCE_THRESHOLD) {
        lastSpokeTime = performance.now();
      }
      // 最低録音時間経過後、かつ直近の発話から2秒以上音がない場合のみチェックアイコンを表示
      if (recordingStartTime && performance.now() - recordingStartTime >= MIN_RECORDING_TIME &&
          lastSpokeTime && performance.now() - lastSpokeTime > SILENCE_DURATION) {
        showCheckIconAndNext();
        return; // チェックアイコン表示後はループを抜ける
      }
      animationId = requestAnimationFrame(updateVolumeMeter);
    }

    function startRecording() {
      isRecording = true;
      recordingStartTime = performance.now();
      lastSpokeTime = performance.now();
      const micBtn = document.getElementById("micBtn");
      if (micBtn) {
        micBtn.classList.add("mic-active");
        micBtn.disabled = false;
      }
      // 録音開始と同時にupdateVolumeMeterを開始
      animationId = requestAnimationFrame(updateVolumeMeter);
    }

    function stopRecording() {
      isRecording = false;
      const micBtn = document.getElementById("micBtn");
      if (micBtn) {
        micBtn.classList.remove("mic-active");
      }
    }

    function showCheckIconAndNext() {
      stopRecording();
      const micBtn = document.getElementById("micBtn");
      if (micBtn) {
        micBtn.disabled = true;
      }
      const checkIcon = document.getElementById("checkIcon");
      if (checkIcon) {
        checkIcon.classList.add("show");
      }
      checkSound.play();
      setTimeout(() => {
        goToNextQuestion();
      }, 2000);
    }

    function showScreen(htmlString) {
      app.innerHTML = htmlString;
    }

    function renderExplanation1() {
      showScreen(explanation1);
      const btn = document.getElementById("goExampleBtn");
      if (btn) {
        btn.addEventListener("click", () => {
          renderExample();
        });
      }
    }

    function renderExample() {
      showScreen(`
        <h2 class="header">Example</h2>
        <div class="question-container">
          <p class="test-sentence">${exampleQuestion.english}</p>
          <p class="japanese-cue">${exampleQuestion.japaneseCue}</p>
          <button class="mic-button" id="micBtn"></button>
          <div class="check-icon" id="checkIcon"></div>
        </div>
      `);
      const micBtn = document.getElementById("micBtn");
      if (micBtn) {
        micBtn.addEventListener("click", () => {
          startRecording();
        });
      }
    }

    function renderExplanation2() {
      showScreen(explanation2);
      const goTestButton = document.getElementById("goTestBtn");
      if (goTestButton) {
        goTestButton.addEventListener("click", () => {
          startTest();
        });
      }
    }

    function renderQuestion(q) {
      showScreen(`
        <div class="question-container">
          <p class="test-sentence">${q.english}</p>
          <p class="japanese-cue">${q.japaneseCue}</p>
          <button class="mic-button" id="micBtn"></button>
          <div class="check-icon" id="checkIcon"></div>
        </div>
      `);
      const micBtn = document.getElementById("micBtn");
      if (micBtn) {
        micBtn.addEventListener("click", () => {
          startRecording();
        });
      }
    }

    function renderFinal() {
      showScreen(explanation3);
    }

    let shuffledQuestions = [];
    let currentQuestionIndex = 0;

    function startTest() {
      shuffledQuestions = shuffle(questions);
      currentQuestionIndex = 0;
      renderQuestion(shuffledQuestions[currentQuestionIndex]);
    }

    function goToNextQuestion() {
      currentQuestionIndex++;
      if (currentQuestionIndex < shuffledQuestions.length) {
        renderQuestion(shuffledQuestions[currentQuestionIndex]);
      } else {
        renderFinal();
      }
    }

    window.addEventListener("DOMContentLoaded", async () => {
      await initAudio();
      renderExplanation1();
      const originalGoNext = goToNextQuestion;
      goToNextQuestion = () => {
        if (currentQuestionIndex === 0 && shuffledQuestions.length === 0) {
          renderExplanation2();
        } else {
          originalGoNext();
        }
      };
    });
  </script>
</body>
</html>
