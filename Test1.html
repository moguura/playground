<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Test 1</title>
  <style>
    /* 全体のレイアウト */
    html, body {
      margin: 0;
      padding: 0;
      font-family: sans-serif;
      background-color: #fff;
      color: #333;
    }
    /* 中央寄せコンテナ */
    .container, #app {
      max-width: 800px;
      margin: 0 auto;
      text-align: center;
      padding: 20px;
    }
    /* 見出し */
    .header {
      font-size: 2.5em;
      margin-bottom: 30px;
    }
    /* 説明文ボックス */
    .explanation-box {
      background-color: #f9f9f9;
      border: 2px solid #ddd;
      padding: 25px;
      margin-bottom: 40px;
      border-radius: 10px;
      text-align: left;
      line-height: 1.6;
      font-size: 1.1em;
    }
    /* ボタンスタイル */
    .button,
    .go-to-test-button {
      display: inline-block;
      background-color: #007BFF;
      color: #fff;
      padding: 16px 32px;
      font-size: 1.2em;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      text-decoration: none;
      transition: background-color 0.3s, transform 0.2s;
    }
    .button:hover,
    .go-to-test-button:hover {
      background-color: #0056b3;
      transform: scale(1.05);
    }
    /* 問題文全体のコンテナ */
    .question-container {
      margin-bottom: 50px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      min-height: 60vh;
    }
    /* メイン文章 */
    .test-sentence {
      font-size: 1.8em;
      margin: 30px 0 20px;
      text-align: center;
      white-space: pre-wrap;
    }
    /* 日本語キュー */
    .japanese-cue {
      font-size: 1.8em;
      color: #006400;
      margin-bottom: 30px;
      text-align: center;
    }
    /* マイクボタン */
    .mic-button {
      width: 80px;
      height: 80px;
      background: url("https://raw.githubusercontent.com/moguura/my-exp-images/main/mic.png") no-repeat center center / contain;
      border: none;
      outline: none;
      cursor: pointer;
      margin: 30px auto;
      transition: transform 0.2s;
      display: inline-block;
    }
    .mic-button:hover {
      transform: scale(1.1);
    }
    .mic-button:active {
      transform: scale(0.95);
    }
    .mic-button.mic-active {
      animation: micGlow 1s infinite alternate;
    }
    @keyframes micGlow {
      0% {
        filter: drop-shadow(0 0 10px rgba(255, 0, 0, 0.5));
      }
      100% {
        filter: drop-shadow(0 0 20px rgba(255, 0, 0, 1));
      }
    }
    /* チェックアイコン */
    .check-icon {
      width: 70px;
      height: 70px;
      background: url("https://raw.githubusercontent.com/moguura/my-exp-images/main/check.png") no-repeat center center / contain;
      display: none;
      margin: 30px auto;
    }
    .check-icon.show {
      display: block;
      animation: pop 0.3s forwards;
    }
    @keyframes pop {
      0% {
        transform: scale(0.5);
        opacity: 0;
      }
      100% {
        transform: scale(1);
        opacity: 1;
      }
    }
    /* テスト終了画面 */
    .final-message {
      text-align: center;
      font-size: 1.4em;
      margin-top: 50px;
    }
    .final-illustration {
      max-width: 350px;
      display: block;
      margin: 30px auto;
    }
  </style>
</head>
<body>
  <div id="app" class="container">
    <!-- コンテンツはJavaScriptで動的に生成されます -->
  </div>
  <script>
    // ===== 事前準備 =====
    const app = document.getElementById("app");

    // クリック音
    const clickSound = new Audio("https://raw.githubusercontent.com/moguura/my-exp-images/main/Click.mp3");
    // チェック音
    const checkSound = new Audio("https://raw.githubusercontent.com/moguura/my-exp-images/main/Submission.mp3");

    let recognition = null;         // SpeechRecognitionオブジェクト
    let silenceTimer = null;        // 無音タイマー
    let saidDesu = false;           // 「です」を言ったかどうか
    let isRecording = false;        // 録音中フラグ（マイクアニメーション用）

    // 無音待機時間を 4000ms に変更（ユーザーの発話ペースに合わせる）
    const SILENCE_WAIT = 4000;

    // ===== 画面に表示するテキスト =====
    const explanation1 = `
      <h2 class="header">Test 1</h2>
      <div class="explanation-box">
        <p>This is a speaking test.<br>
        Press the microphone button and speak.<br>
        Now, let's try an example. Press the microphone button and say "よくないです".</p>
      </div>
      <button class="button" id="goExampleBtn">Next</button>
    `;

    const exampleQuestion = {
      english: "The weather is not good.",
      japaneseCue: "いい → てんきは（　　　）"
    };

    const explanation2 = `
      <div class="explanation-box">
        <p>The weather is not good. Therefore, "いい" becomes "よくないです."<br>
        Similarly, change the form of い-adjectives and speak the word that fits in the (　　 ).<br><br>
        When you're ready, press the GO TO TEST button to begin.</p>
      </div>
      <button class="go-to-test-button" id="goTestBtn">GO TO TEST</button>
    `;

    const explanation3 = `
      <div class="explanation-box">
        <p>This is the end of Test 1. Please click the X at the top to close this tab.</p>
      </div>
      <img src="https://raw.githubusercontent.com/moguura/my-exp-images/main/cracker.gif"
           alt="Cracker GIF" class="final-illustration">
    `;

    // 16問の問題リスト（ランダム表示）
    const questions = [
      { english: "The class is interesting.", japaneseCue: "おもしろい → じゅぎょうは（　　　）" },
      { english: "This pasta is spicy.", japaneseCue: "からい → このパスタは（　　　）" },
      { english: "The medicine is not tasty.", japaneseCue: "おいしい → くすりは（　　　）" },
      { english: "Studying is not difficult.", japaneseCue: "むずかしい → べんきょうは（　　　）" },
      { english: "The food was expensive.", japaneseCue: "たかい → りょうりは（　　　）" },
      { english: "This T-shirt was cheap.", japaneseCue: "やすい → このTシャツは（　　　）" },
      { english: "The cake was not big.", japaneseCue: "おおきい → ケーキは（　　　）" },
      { english: "February was not cold.", japaneseCue: "さむい → 2がつは（　　　）" },
      { english: "The house is not new.", japaneseCue: "あたらしい → いえは（　　　）" },
      { english: "Last week was hot.", japaneseCue: "あつい → せんしゅうは（　　　）" },
      { english: "The game is fun.", japaneseCue: "たのしい → ゲームは（　　　）" },
      { english: "There was a lot of luggage.", japaneseCue: "おおい → にもつは（　　　）" },
      { english: "This book is heavy.", japaneseCue: "おもい → このほんは（　　　）" },
      { english: "The mountain was not cool.", japaneseCue: "すずしい → やまは（　　　）" },
      { english: "The school is not close.", japaneseCue: "ちかい → がっこうは（　　　）" },
      { english: "The hot spring was not cold.", japaneseCue: "つめたい → おんせんは（　　　）" }
    ];

    // ===== ユーティリティ関数 =====
    function showScreen(htmlString) {
      app.innerHTML = htmlString;
    }
    function shuffle(array) {
      const arr = [...array];
      for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      return arr;
    }

    // ===== SpeechRecognition の初期化 =====
    function initSpeechRecognition() {
      if (!("webkitSpeechRecognition" in window) && !("SpeechRecognition" in window)) {
        console.warn("このブラウザはSpeechRecognition APIをサポートしていません。");
        return null;
      }
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      const recog = new SpeechRecognition();
      recog.lang = "ja-JP";
      recog.interimResults = true; // 中間結果も取得
      recog.continuous = true;
      return recog;
    }

    // ===== 無音タイマー管理 =====
    function startSilenceTimer() {
      clearSilenceTimer();
      silenceTimer = setTimeout(() => {
        // 3秒以上無音なら停止（「です」が検出されなかった場合）
        stopRecognition(false);
      }, SILENCE_WAIT);
    }
    function clearSilenceTimer() {
      if (silenceTimer) {
        clearTimeout(silenceTimer);
        silenceTimer = null;
      }
    }

    // ===== 音声認識開始 =====
    function startRecognition() {
      clickSound.play();  // クリック音再生

      // マイクボタンは1回のみ有効にする
      const micBtn = document.getElementById("micBtn");
      micBtn.disabled = true;
      micBtn.classList.add("mic-active");
      isRecording = true;
      saidDesu = false;

      if (!recognition) {
        recognition = initSpeechRecognition();
        if (!recognition) {
          console.warn("SpeechRecognitionが初期化できませんでした。");
          return;
        }
      }

      recognition.onstart = () => {
        console.log("Recognition started");
        startSilenceTimer();
      };

      recognition.onresult = (event) => {
        // 中間結果も含め、結果をチェック
        const results = event.results;
        for (let i = event.resultIndex; i < results.length; i++) {
          const transcript = results[i][0].transcript.trim();
          console.log("認識結果:", transcript);
          if (results[i].isFinal && transcript.endsWith("です")) {
            saidDesu = true;
            stopRecognition(true);
            break;
          }
        }
      };

      recognition.onspeechstart = () => {
        clearSilenceTimer();
      };

      recognition.onspeechend = () => {
        startSilenceTimer();
      };

      recognition.onerror = (e) => {
        console.warn("Recognition error:", e);
        stopRecognition(false);
      };

      recognition.onend = () => {
        console.log("Recognition ended");
      };

      recognition.start();
    }

    // ===== 音声認識停止 =====
    // withDesu: 「です」を認識して停止した場合は true、それ以外は false
    function stopRecognition(withDesu) {
      if (!recognition || !isRecording) return;
      recognition.stop();
      clearSilenceTimer();
      const micBtn = document.getElementById("micBtn");
      micBtn.classList.remove("mic-active");
      isRecording = false;
      if (withDesu) {
        showCheckIcon();
      } else {
        // 無音で停止した場合も、2秒後に次の問題へ進む
        setTimeout(() => {
          goToNextQuestion();
        }, 2000);
      }
    }

    // ===== チェックアイコン表示 =====
    function showCheckIcon() {
      const checkIcon = document.getElementById("checkIcon");
      if (checkIcon) {
        checkIcon.classList.add("show");
      }
      checkSound.play();
      setTimeout(() => {
        goToNextQuestion();
      }, 2000);
    }

    // ===== 画面描画関連 =====
    function renderExplanation1() {
      showScreen(explanation1);
      const btn = document.getElementById("goExampleBtn");
      if (btn) {
        btn.addEventListener("click", () => {
          clickSound.play();
          renderExample();
        });
      }
    }

    function renderExample() {
      showScreen(`
        <h2 class="header">Example</h2>
        <div class="question-container">
          <p class="test-sentence">${exampleQuestion.english}</p>
          <p class="japanese-cue">${exampleQuestion.japaneseCue}</p>
          <button class="mic-button" id="micBtn"></button>
          <div class="check-icon" id="checkIcon"></div>
        </div>
      `);
      const micBtn = document.getElementById("micBtn");
      if (micBtn) {
        micBtn.addEventListener("click", startRecognition);
      }
    }

    function renderExplanation2() {
      showScreen(explanation2);
      const goTestButton = document.getElementById("goTestBtn");
      if (goTestButton) {
        goTestButton.addEventListener("click", () => {
          clickSound.play();
          startTest();
        });
      }
    }

    function renderQuestion(q) {
      showScreen(`
        <div class="question-container">
          <p class="test-sentence">${q.english}</p>
          <p class="japanese-cue">${q.japaneseCue}</p>
          <button class="mic-button" id="micBtn"></button>
          <div class="check-icon" id="checkIcon"></div>
        </div>
      `);
      const micBtn = document.getElementById("micBtn");
      if (micBtn) {
        micBtn.addEventListener("click", startRecognition);
      }
    }

    function renderFinal() {
      showScreen(explanation3);
    }

    // ===== テスト進行関連 =====
    let shuffledQuestions = [];
    let currentQuestionIndex = 0;
    function startTest() {
      shuffledQuestions = shuffle(questions);
      currentQuestionIndex = 0;
      renderQuestion(shuffledQuestions[currentQuestionIndex]);
    }
    function goToNextQuestion() {
      currentQuestionIndex++;
      if (currentQuestionIndex < shuffledQuestions.length) {
        renderQuestion(shuffledQuestions[currentQuestionIndex]);
      } else {
        renderFinal();
      }
    }

    // ===== 初期起動処理 =====
    window.addEventListener("DOMContentLoaded", () => {
      renderExplanation1();
      const originalGoNext = goToNextQuestion;
      goToNextQuestion = () => {
        if (currentQuestionIndex === 0 && shuffledQuestions.length === 0) {
          renderExplanation2();
        } else {
          originalGoNext();
        }
      };
    });
  </script>
</body>
</html>
