<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Test 1</title>
  <style>
    /* 全体のレイアウト */
    html, body {
      margin: 0;
      padding: 0;
      font-family: sans-serif;
      background-color: #fff;
      color: #333;
    }
    /* 中央寄せコンテナ */
    .container, #app {
      max-width: 800px;
      margin: 0 auto;
      text-align: center;
      padding: 20px;
    }
    /* 見出し */
    .header {
      font-size: 2.2em;
      margin-bottom: 20px;
    }
    /* 説明ボックス（ビデオ再生用） */
    .video-box {
      margin-bottom: 40px;
      text-align: center;
    }
    .video-box video {
      max-width: 100%;
      border-radius: 10px;
    }
    /* ボタンスタイル */
    .button,
    .go-to-test-button {
      display: inline-block;
      background-color: #007BFF;
      color: #fff;
      padding: 14px 28px;
      font-size: 1.1em;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      text-decoration: none;
      transition: background-color 0.3s, transform 0.2s;
      margin-top: 15px;
    }
    .button:hover,
    .go-to-test-button:hover {
      background-color: #0056b3;
      transform: scale(1.05);
    }
    /* 進捗バー */
    .progress-container {
      display: flex;
      justify-content: center;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    .progress-step {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      border: 2px solid #007BFF;
      color: #007BFF;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 5px;
      font-weight: bold;
      transition: background-color 0.3s, color 0.3s;
    }
    .progress-step.completed,
    .progress-step.active {
      background-color: #007BFF;
      color: #fff;
    }
    /* 問題・例の画面コンテナ */
    .question-container {
      margin-bottom: 40px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      min-height: 50vh;
    }
    /* 中央の画像 */
    .question-image {
      max-width: 70%;
      height: auto;
      display: block;
      margin: 0 auto;
    }
    /* 遷移画面用の画像 */
    .transition-image {
      max-width: 80%;
      height: auto;
      display: block;
      margin: 0 auto;
    }
    /* 日本語キュー */
    .japanese-cue {
      font-size: 1.6em;
      color: #006400;
      margin: 25px 0 30px;
      text-align: center;
      white-space: pre-wrap;
    }
    /* マイクボタン */
    .mic-button {
      width: 80px;
      height: 80px;
      background: url("https://raw.githubusercontent.com/moguura/my-exp-images/main/mic.png") no-repeat center center / contain;
      border: none;
      outline: none;
      cursor: pointer;
      transition: transform 0.2s;
    }
    .mic-button:hover {
      transform: scale(1.1);
    }
    .mic-button:active {
      transform: scale(0.95);
    }
    .mic-button.mic-active {
      animation: micGlow 1s infinite alternate;
    }
    @keyframes micGlow {
      0% { filter: drop-shadow(0 0 10px rgba(255, 0, 0, 0.5)); }
      100% { filter: drop-shadow(0 0 20px rgba(255, 0, 0, 1)); }
    }
    /* マイク・チェックアイコンのコンテナ */
    .mic-container { position: relative; display: inline-block; }
    /* チェックアイコン */
    .check-icon {
      position: absolute;
      top: 50%; left: calc(100% + 10px);
      transform: translateY(-50%);
      width: 70px; height: 70px;
      background: url("https://raw.githubusercontent.com/moguura/my-exp-images/main/check.png") no-repeat center center / contain;
      display: none;
    }
    .check-icon.show { display: block; animation: pop 0.3s forwards; }
    @keyframes pop { 0% { transform: scale(0.5); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
    /* 警告メッセージ */
    .mic-warning { color: red; font-size: 1.2em; margin-top: 10px; }
    /* テスト終了画面 */
    .final-message { text-align: center; font-size: 1.4em; margin-top: 50px; }
    .final-illustration { max-width: 150px; display: block; margin: 30px auto; }
    /* ログ保存ボタン */
    #downloadLogButton {
      display: inline-block;
      background-color: #4CAF50;
      color: #fff;
      padding: 10px 20px;
      font-size: 1.1em;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      margin-top: 20px;
      transition: background-color 0.3s;
    }
    #downloadLogButton:hover { background-color: #388E3C; }
  </style>
</head>
<body>
  <div id="app" class="container"></div>

  <!-- ログ永続化＆ダウンロード用 -->
  <script>
    (function() {
      const logBuffer = [];
      const originalLog = console.log;
      console.log = function(...args) {
        const message = args.join(' ');
        logBuffer.push(message);
        originalLog.apply(console, args);
        localStorage.setItem('consoleLog', logBuffer.join('\n'));
      };
      window.saveLog = function() {
        const logContent = localStorage.getItem('consoleLog') || '';
        const blob = new Blob([logContent], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'console-log.txt';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      };
    })();
  </script>

  <script>
    const clickSound = new Audio("https://raw.githubusercontent.com/moguura/my-exp-images/main/Click.mp3");
    const checkSound = new Audio("https://raw.githubusercontent.com/moguura/my-exp-images/main/Submission.mp3");
    let recognition = null, recordTimeout = null, isRecording = false, micWarningTimeout = null;

    function initSpeechRecognition() {
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!SpeechRecognition) { alert("このブラウザはSpeechRecognition APIをサポートしていません。"); return null; }
      const recog = new SpeechRecognition();
      recog.lang = "ja-JP";
      recog.interimResults = true;
      recog.continuous = true;
      return recog;
    }

    function startRecognition() {
      clickSound.play(); clearTimeout(micWarningTimeout);
      if (!recognition) { recognition = initSpeechRecognition(); if (!recognition) return; }
      const micBtn = document.getElementById("micBtn");
      micBtn.disabled = true; micBtn.classList.add("mic-active");
      isRecording = true;
      recordTimeout = setTimeout(stopRecognition, 10000);
      recognition.onresult = (event) => {
        for (let i = event.resultIndex; i < event.results.length; i++) {
          const transcript = event.results[i][0].transcript.trim();
          if (transcript.includes("です")) { stopRecognition(); break; }
        }
      };
      recognition.onerror = () => { console.warn("Recognition error"); stopRecognition(); };
      recognition.onend = () => { console.log("Recognition ended"); };
      recognition.start();
    }

    function stopRecognition() {
      if (!recognition || !isRecording) return;
      clearTimeout(recordTimeout);
      recognition.stop(); isRecording = false;
      document.getElementById("micBtn").classList.remove("mic-active");
      showCheckIcon();
    }

    function showCheckIcon() {
      document.getElementById("checkIcon").classList.add("show");
      checkSound.play(); setTimeout(goNext, 2000);
    }

    const app = document.getElementById("app");
    function showScreen(html) { app.innerHTML = html; }
    function renderProgressBar(currentIndex, total) {
      let steps = "";
      for (let i = 0; i < total; i++) {
        let className = "progress-step";
        if (i < currentIndex) className += " completed";
        else if (i === currentIndex) className += " active";
        steps += `<span class="${className}">${i + 1}</span>`;
      }
      return `<div class="progress-container">${steps}</div>`;
    }
    function shuffle(array) { const arr = [...array]; for (let i = arr.length-1; i>0; i--) { const j=Math.floor(Math.random()* (i+1)); [arr[i],arr[j]]=[arr[j],arr[i]]; } return arr; }

    // 説明ビデオ定義
    const explanationBox1 = `
      <div class="video-box">
        <video src="https://raw.githubusercontent.com/moguura/my-exp-images/main/test1-1.mp4" controls></video>
      </div>
      <button class="button" id="nextBtn1">Next</button>
    `;

    const explanationBox2 = `
      <div class="video-box">
        <video src="https://raw.githubusercontent.com/moguura/my-exp-images/main/test1-2.mp4" controls></video>
      </div>
      <button class="button" id="nextBtn2">Next</button>
    `;

    const explanationBox3 = `
      <div class="video-box">
        <video src="https://raw.githubusercontent.com/moguura/my-exp-images/main/test1-3new.mp4" controls></video>
      </div>
      <button class="go-to-test-button" id="goTestBtn">GO TO TEST</button>
    `;

    const explanationBox4 = `
      <div class="explanation-box" style="text-align:center;">
        <p>... (終了＆ログ保存画面) ...</p>
        <button id="downloadLogButton">DO NOT TOUCH</button>
      </div>
    `;

    // 以下、例題・問題データ、およびレンダリング関数は従来通り
    /* 例題、問題データ、renderStage等省略 */

    let stageIndex = 0, shuffledQuestions = [];
    function renderStage(index) {
      if (index === 0) {
        showScreen(explanationBox1);
        document.getElementById("nextBtn1").addEventListener("click", () => { clickSound.play(); goNext(); });
      } else if (index === 1) {
        renderTransitionScreen(presentTransition.imgUrl, index+1);
      } else if (index === 2) {
        renderExample(example1);
      } else if (index === 3) {
        showScreen(explanationBox2);
        document.getElementById("nextBtn2").addEventListener("click", () => { clickSound.play(); goNext(); });
      } else if (index === 4) {
        renderTransitionScreen(yesterdayTransition.imgUrl, index+1);
      } else if (index === 5) {
        renderExample(example2);
      } else if (index === 6) {
        showScreen(explanationBox3);
        document.getElementById("goTestBtn").addEventListener("click", () => { clickSound.play(); startTest(); });
      } else if (index >= 7 && index < 47) {
        // テスト問題部分
        // ...
      } else if (index === 47) {
        showScreen(explanationBox4);
        document.getElementById("downloadLogButton").addEventListener("click", window.saveLog);
      }
    }

    window.addEventListener("DOMContentLoaded", () => { renderStage(stageIndex); });
  </script>
</body>
</html>
